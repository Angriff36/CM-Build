@startuml component_overview
!include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml

title CaterKing Platform - Component Overview

' =============================================================================
' Narrative:
' The architecture follows a Modular Monolith approach (Turbo repo) where business capability
' lives inside bounded libraries while Next.js apps orchestrate composition.
' - Apps: Lightweight Next.js 15 surfaces (PrepChef, Admin, etc.)
' - Shared Libs: Encapsulate domain models, UI design system, and Supabase adapters.
' - Supabase Services: Backend-as-a-Service providing DB, Auth, Realtime, and Storage.
' - Ops Tooling: Doppler (secrets), Flagsmith (feature flags), and Observability.
' =============================================================================

LAYOUT_WITH_LEGEND()

' =============================================================================
AddElementTag("app", $fontColor="White", $bgColor="DarkSlateBlue", $borderColor="Lavender")
AddElementTag("lib", $fontColor="Black", $bgColor="Moccasin", $borderColor="Goldenrod")
AddElementTag("service", $fontColor="White", $bgColor="DarkGreen", $borderColor="PaleGreen")
AddElementTag("ops", $fontColor="Black", $bgColor="Gainsboro", $borderColor="DimGray")
AddRelTag("rsc", $textColor="DarkCyan")
AddRelTag("rpc", $textColor="DarkMagenta")
' =============================================================================

System_Boundary(caterking_suite, "CaterKing Suite") {
  Container(app_prepchef, "apps/prepchef", "Next.js 15 (RSC + React Query)", "Mobile-first staff PWA for prep execution.") <<app>>
  Container(app_caterking, "apps/caterking", "Next.js 15 (RSC)", "Lightweight operations app for smaller teams.") <<app>>
  Container(app_admin, "apps/admin-crm", "Next.js 15 (SSR + hydration)", "Desktop admin and manager dashboard for events, staff, and recipes.") <<app>>
  Container(app_display, "apps/display", "Next.js 15 (ISR + polling)", "Passive kiosk/wall display for status boards and alerts.") <<app>>
  Container(app_api, "Next.js API Routes & Server Actions", "Edge/Node runtimes", "REST-ish endpoints and mutations calling Supabase RPCs.") <<app>>
}

' =============================================================================
System_Boundary(shared_libs, "Shared Libraries") {
  Container(lib_ui, "libs/ui", "TypeScript + Tailwind + ShadCN", "Design system, typography tokens, gloves-friendly components.") <<lib>>
  Container(lib_shared, "libs/shared", "TypeScript Domain Models + Zod", "Domain schemas, validators, heuristic utilities, enums.") <<lib>>
  Container(lib_supabase, "libs/supabase", "Typed Supabase Client Wrapper", "RLS-safe client factory, RPC helpers, realtime adapters.") <<lib>>
  Container(lib_rag, "libs/rag", "Python ingestion utilities", "Document ingestion + semantic prep for RAG tasks (future).") <<lib>>
  Container(lib_mcp, "libs/mcp", "Tooling/Integrations", "MCP + automation helpers for integration scenarios.") <<lib>>
}

' =============================================================================
System_Boundary(supabase_services, "Supabase Services") {
  ContainerDb(db_postgres, "Supabase Postgres", "Managed Postgres + RLS", "Stores companies, users, events, tasks, recipes, audit logs.") <<service>>
  ContainerDb(db_storage, "Supabase Storage", "Object Storage + CDN", "Holds media assets, method videos, thumbnails per company.") <<service>>
  Container(queue_realtime, "Supabase Realtime Channels", "Phoenix websockets", "Broadcasts change feeds per `company:{company_id}:{entity}`.") <<service>>
  Container(queue_functions, "Supabase Edge Functions", "Deno-based functions", "Executes heuristics, media processing callbacks, scheduled jobs.") <<service>>
  Container(materialized_views, "Display Summaries", "Materialized Views + Cron", "Pre-computed stats for kiosk display fallbacks.") <<service>>
}

' =============================================================================
Container(flagsmith_adapter, "Feature Flag Adapter", "Flagsmith SDK wrapper", "Server + client evaluation of feature flags, exposures, and variants.") <<ops>>
Container(doppler_cli, "Doppler Runtime Config", "Doppler CLI + Templates", "Injects secrets into Vercel and Supabase environments.") <<ops>>
Container(observability_adapter, "Observability Stack Adapter", "OpenTelemetry + Log shipping", "Collects traces, logs, metrics for pipelines and alerting.") <<ops>>
Container(notification_dispatcher, "Notification Dispatcher", "In-app toasts + future push connectors", "Handles toasts, undo prompts, and future channels.") <<ops>>

' =============================================================================
note right of shared_libs
  Libraries enforce named exports only; no defaults.
  Apps may only import via @caterkingapp/* aliases.
end note
note bottom of supabase_services
  Every table carries company_id and RLS policies.
  Cron jobs refresh kiosk summaries and archive audit logs.
end note
note left of caterking_suite
  All Next.js apps share server components and typed hooks.
  Each app can be filtered via turbo build --filter <app>.
end note

' =============================================================================
Rel(app_prepchef, lib_ui, "Consumes gloves-friendly design primitives.", "RSC composition") <<rsc>>
Rel(app_prepchef, lib_shared, "Uses task enums, DTOs, heuristics.", "Type imports") <<rsc>>
Rel(app_prepchef, lib_supabase, "Queries Supabase Postgres + Realtime.", "Supabase client")
Rel(app_prepchef, app_api, "Invokes server actions for claim/complete/combine.", "HTTPS / fetch")
Rel(app_prepchef, queue_realtime, "Subscribes to realtime task and recipe channels.", "Supabase Realtime websocket")
Rel(app_prepchef, notification_dispatcher, "Publishes toasts + undo prompts.", "Client events")
Rel(app_prepchef, observability_adapter, "Streams user interactions for telemetry.", "OTLP spans")

' =============================================================================
Rel(app_caterking, lib_ui, "Shares simplified dashboards and components.", "RSC")
Rel(app_caterking, lib_shared, "Reads event/task DTOs.", "Type imports")
Rel(app_caterking, lib_supabase, "Uses shared queries + RPC helpers.", "Supabase client")
Rel(app_caterking, queue_realtime, "Subscribes to aggregated event channels.", "Realtime websockets")
Rel(app_caterking, notification_dispatcher, "Displays approval prompts and alerts.", "Client events")

' =============================================================================
Rel(app_admin, lib_ui, "Leverages admin forms, tables, media uploaders.", "SSR + hydration")
Rel(app_admin, lib_shared, "Validates recipes, methods, staff roles.", "Zod validators")
Rel(app_admin, lib_supabase, "Executes RPC for staff assignment, recipe edits.", "Supabase client")
Rel(app_admin, queue_functions, "Triggers Supabase functions for heavy heuristics.", "Function invocation")
Rel(app_admin, db_storage, "Requests signed URLs for media uploads.", "Supabase storage API")
Rel(app_admin, doppler_cli, "Coordinates secret rotations + environment setup.", "CLI / pipeline")
Rel(app_admin, flagsmith_adapter, "Controls feature flag toggles + exposures.", "SDK / GraphQL")

' =============================================================================
Rel(app_display, lib_ui, "Renders passive tiles + summary components.", "ISR / streaming")
Rel(app_display, lib_shared, "Uses summary DTOs + role enums.", "Type imports")
Rel(app_display, lib_supabase, "Reads summary endpoints + Realtime snapshots.", "Supabase client")
Rel(app_display, materialized_views, "Fetches precomputed digests for fallback mode.", "SQL polling")
Rel(app_display, queue_realtime, "Listens to display channels when realtime available.", "Realtime websockets")

' =============================================================================
Rel(app_api, lib_shared, "Validates payloads + enforces schema_version.", "Type usage")
Rel(app_api, lib_supabase, "Calls RPC, checks RLS, wraps idempotency tokens.", "Supabase service role client") <<rpc>>
Rel(app_api, db_postgres, "Executes RPC/stored procedures for tasks, recipes, roles.", "RPC / SQL")
Rel(app_api, queue_functions, "Dispatches heavy heuristics + media processing to Supabase functions.", "Function calls")
Rel(app_api, queue_realtime, "Pushes realtime events via Postgres triggers.", "Notify / Broadcast")
Rel(app_api, db_storage, "Issues signed URLs + handles callbacks.", "Storage API")
Rel(app_api, flagsmith_adapter, "Reads flags to guard endpoints + responses.", "SDK")
Rel(app_api, observability_adapter, "Emits structured logs + traces.", "OTLP")

' =============================================================================
Rel(lib_ui, lib_shared, "Respects domain naming, status tokens, role constants.", "Type imports")
Rel(lib_shared, lib_supabase, "Supplies typed DTOs + validators to RPC layer.", "Type + helper usage")
Rel(lib_supabase, db_postgres, "Executes typed queries + RPC calls.", "Supabase client")
Rel(lib_supabase, queue_realtime, "Subscribes/unsubscribes to channels per company.", "Realtime client")
Rel(lib_rag, db_storage, "Ingests documents for knowledge base (future).", "Signed URLs")
Rel(lib_mcp, app_admin, "Provides connectors for MCP-powered workflows.", "Automation pipeline")

' =============================================================================
Rel(db_postgres, queue_realtime, "Triggers broadcast via Postgres changes.", "Replication slots")
Rel(db_postgres, materialized_views, "Feeds view refresh jobs for kiosk summaries.", "SQL refresh")
Rel(db_storage, queue_functions, "Invokes transcoding + metadata extraction after upload.", "Storage webhook")
Rel(queue_functions, db_postgres, "Writes heuristic results + audit logs.", "RPC / SQL")
Rel(queue_functions, queue_realtime, "Publishes summary updates after processing.", "Realtime push")

' =============================================================================
Rel(flagsmith_adapter, observability_adapter, "Logs flag exposures + errors for auditing.", "Telemetry stream")
Rel(notification_dispatcher, app_prepchef, "Delivers toasts + undo prompts into UI component tree.", "Client events")
Rel(notification_dispatcher, app_caterking, "Mirrors notifications for managers.", "Client events")
Rel(notification_dispatcher, app_admin, "Notifies admin of slow fetches or policy violations.", "Client events")
Rel(doppler_cli, app_api, "Provides runtime secrets for Supabase + Flagsmith + storage keys.", "CI/CD injection")

' =============================================================================
SHOW_LEGEND()
' =============================================================================
@enduml
