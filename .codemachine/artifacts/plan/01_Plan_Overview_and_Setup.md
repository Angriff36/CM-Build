<!-- anchor: project-plan-root -->
# Project Plan: CaterKing Kitchen Management Platform

**Version:** 1.0
**Date:** 2025-12-10
**Generated By:** Codex (GPT-5)

<!-- anchor: project-overview -->
## 1. Project Overview

*   **Goal:** Deliver a multi-tenant, real-time kitchen operations suite that centralizes prep tasks, recipes, methods, and staffing so staff, managers, and owners share an identical, low-latency source of truth spanning mobile, web, and wall displays.
*   **High-Level Requirements Summary:**
    - Multi-event task board with claim/unclaim/complete flows, assignment, undo, and presence awareness across PrepChef PWA, CaterKing Lite, admin CRM, and kiosk displays.
    - Task consolidation heuristics that normalize ingredients, convert units, and propose manager-approved combined work without sacrificing traceability.
    - Recipes, methods, and training media per company with versioning, media uploads, and contextual drawers available inline while cooking.
    - Strict RBAC (staff, manager, event lead, owner) enforced through Supabase Auth + RLS, with audit logs covering high-risk operations.
    - Supabase-first data plane (Postgres, Realtime, Storage, Edge Functions) orchestrated through a Turbo monorepo of Next.js 15 apps that share typed libraries, tests, and feature flags.
    - Doppler-managed secrets, Flagsmith-governed feature rollout, pnpm/turbo workflows, and mandatory telemetry/testing/CI guardrails.
*   **Key Assumptions:**
    - MVP targets a single kitchen location with <=5 concurrent events yet architecture must scale to multi-site by reusing company_id partitioning.
    - PrepChef mobile experience ships as a PWA first; future Expo shells reuse the same hooks and UI kits.
    - Supabase remains system of record; no alternate databases/caches until profiling proves necessary.
    - Offline mode is intentionally fail-closed; clients surface banners and block mutations without connectivity.
    - Media uploads capped at ~500MB per asset with best-effort transcoding; thumbnails mandatory, advanced encoding optional future work.
    - Undo windows stay within five minutes unless feature flag `prep.undo-extended-window` proves safe for select tenants.
    - Regulatory needs stop at audit logs + retention; HIPAA/FDA-style logging deferred until new directive appears.

<!-- anchor: core-architecture -->
## 2. Core Architecture

*   **Architectural Style:** Modular monolithic Turbo repo containing multiple Next.js App Router apps (PrepChef, CaterKing Lite, Admin CRM, Display) sharing typed domain, UI, and Supabase client libraries; Supabase provides Postgres/RLS, Auth, Storage, Functions, and Realtime while Doppler/Flagsmith/Observability back operational controls.
*   **Technology Stack:**
    *   Frontend: Next.js 15 App Router + React 18 (Server Components + streaming), Tailwind CSS + ShadCN via `@caterkingapp/ui`, React Query, Supabase Realtime adapters, Storybook/Playwright for validation.
    *   Backend: Next.js server actions/API routes (Edge + Node runtimes) invoking Supabase SQL/RPC, Supabase Edge Functions for heuristics/media/transforms, pnpm/turbo orchestrated builds.
    *   Database: Supabase Postgres with JSONB-heavy schemas for recipes/methods, pgTAP-tested migrations, company-scoped RLS, PITR backups.
    *   Messaging/Queues: Supabase Realtime channels per `company:{company_id}:{entity}`, Postgres triggers, optional cron-style job tables (no external broker initially).
    *   Deployment: Vercel for apps/APIs, Supabase managed services, Doppler secrets, Flagsmith feature flags, GitHub Actions for CI.
    *   Other Libraries/Tools: Zod validators, OpenTelemetry instrumentation, Pino logging, Flagsmith SDK, Doppler CLI, Supabase CLI, Changesets, Vitest, Playwright, Chromatic.
*   **Key Components/Services:**
    - PrepChef PWA (apps/prepchef) for staff with streaming task board, recipe drawer, undo toasts, and realtime presence (Component Diagram refined in I1.T3).
    - CaterKing Lite (apps/caterking) delivering condensed dashboards for smaller teams with shared hooks (Sequence diagram refined in I2.T4).
    - Admin CRM (apps/admin-crm) for planning, assignment, recipe/method CMS, media uploads, RBAC operations, and audit tooling.
    - Display/Kiosk app (apps/display) showing passive status boards with summary API fallbacks.
    - Shared libraries (`libs/ui`, `libs/shared`, `libs/supabase`, `libs/rag`, `libs/mcp`) enforcing domain models, UI primitives, Supabase access, and tooling.
    - Supabase schema + RPC suite (`supabase/migrations`, `supabase/functions`, `libs/supabase/src/types.ts`) owning RLS, stored procedures (`claim_task`, `complete_task`, `combine_tasks`, etc.), and cron tasks.
    - Task aggregation heuristic engine (Supabase function) for normalization + suggestion generation.
    - Media pipeline (Supabase Storage + Edge Functions) covering uploads, transcoding, thumbnails, and metadata hydration.
    - Feature flag + observability stack (Flagsmith, Doppler, OpenTelemetry, log drains) to gate experiments and surface runtime health.
*   **Data Model Overview:** Core entities: Company -> Users (roles + presence) -> Events -> Tasks -> CombinedTaskGroups + TaskComments; Recipes + MethodDocuments + MediaAssets; RoleAssignments, AuditLogs, NotificationPreferences, RealtimeSubscriptions, StaffSchedules, Stations, DisplaySnapshots. Every table includes `company_id`, timestamps, versioning/undo metadata, and RLS policies referencing Supabase Auth claims. JSONB columns capture ingredients, steps, heuristics metadata, and audit diffs; GIN/BTree indexes accelerate filters (status, station, role, version).
*   **API Contract Style:** REST-ish JSON over Next.js App Router routes, described via OpenAPI v3 spec stored under `api/`. Mutations call Supabase RPC functions with idempotency keys; responses include `schema_version`, `audit_reference_id`, and realtime channel hints. DTOs validated with shared Zod schemas; incompatible clients receive `426` with remediation links. Realtime complements, never replaces, API fetches to maintain deterministic caches.
*   **Communication Patterns:** Clients perform streaming server-rendered fetches, hydrate React Query caches, optimistically mutate via RPC wrappers, and subscribe to Supabase Realtime channels per entity. Realtime outages trigger documented polling fallback (`/api/tasks?since=`). Feature flags evaluated server-side, injected into client contexts, and logged. Undo + notification flows rely on shared dispatcher pushing toasts + TTL timers; audit logs replicate to observability sinks for compliance.

<!-- anchor: key-artifacts -->
## 2.1. Key Architectural Artifacts Planned

*   Component Diagram (PlantUML) - Visualize PrepChef PWA components, shared hooks, and Supabase adapters (Created in I1.T3, stored at `docs/diagrams/prepchef_components.puml`).
*   Supabase Schema ERD (Mermaid) - Document tenant-scoped tables, relationships, and undo metadata for migrations/review (Created in I1.T4, `docs/diagrams/supabase_erd.mmd`).
*   Task Lifecycle Sequence Diagram (PlantUML) - Claim/complete/undo flow across PrepChef, API, RPC, Realtime, Display (Created in I2.T4, `docs/diagrams/task_lifecycle_seq.puml`).
*   Multi-event Component Diagram (PlantUML) - Show Admin CRM, Display, Aggregation engine, feature flag services (Created in I2.T5, `docs/diagrams/system_component_overview.puml`).
*   Knowledge Base Content Flow Diagram (Mermaid flowchart) - Map recipe/method editing, media pipeline, Drawer consumption (Created in I3.T3, `docs/diagrams/knowledge_flow.mmd`).
*   Task Combination Heuristic Spec (Markdown + JSON samples) - Define normalization pipeline, tuning levers, feature flag gating (Created in I4.T2, `docs/specs/task_combination.md`).
*   OpenAPI v3 Spec Draft (YAML) - Cover core routes (`/api/tasks`, `/api/events`, `/api/recipes`, `/api/tasks/combine`) (Created in I2.T2, iterated in I4.T3, stored under `api/openapi.yaml`).
*   Supabase RLS Policy Catalog (Markdown) - Enumerate policies, impersonation tests, and pgTAP coverage (Created in I1.T5, updated in I3.T6, `docs/security/rls_policies.md`).
*   UI Interaction Blueprint (Markdown + embedded Mermaid) - Capture key PrepChef flows, display rotations, and offline banners (Created in I3.T4, `docs/ux/ui_interaction_blueprint.md`).
*   CI/CD Pipeline Diagram (Mermaid) - Document turbo workflows, Supabase migrations, Doppler + Flagsmith gating (Created in I5.T3, `docs/diagrams/cicd_pipeline.mmd`).

<!-- anchor: directory-structure -->
## 3. Directory Structure

*   **Root Directory:** `caterking-platform/`
*   **Structure Definition:**
```
caterking-platform/
|-- apps/
|   |-- prepchef/                 # PWA for staff with server components + React Query hooks
|   |-- caterking/                # Lightweight dashboards for smaller crews
|   |-- admin-crm/                # Manager/admin console for events, recipes, staff, media
|   `-- display/                  # Passive wall/kiosk screens with snapshot fallback
|-- libs/
|   |-- ui/                       # ShadCN/Tailwind components, tokens, Storybook stories
|   |-- shared/                   # Domain models, Zod schemas, access guards, feature flag helpers
|   |-- supabase/                 # Typed client factory, RPC wrappers, realtime adapters
|   |-- rag/                      # Training/method ingestion utilities (future-ready)
|   `-- mcp/                      # MCP/automation connectors used by ops tooling
|-- supabase/
|   |-- migrations/               # SQL migrations + RLS policies with pgTAP tests
|   |-- functions/                # Edge functions for heuristics, media, cron jobs
|   `-- seed/                     # Tenant/persona fixture data for dev/staging/testing
|-- docs/
|   |-- diagrams/                 # PlantUML/Mermaid sources for components, ERDs, flows
|   |-- specs/                    # Markdown specs (heuristics, undo, API behavior)
|   |-- security/                 # RLS policy catalog, audit procedures, access reviews
|   |-- ux/                       # Interaction blueprints, story maps, tokens references
|   `-- adr/                      # Architecture decision records referencing blueprint anchors
|-- api/
|   |-- openapi.yaml              # REST contract, iteratively refined each iteration
|   `-- schemas/                  # JSON schema fragments for DTO validation/testing
|-- tests/
|   |-- playwright/               # Cross-surface E2E flows (claim, recipe view, combine, admin)
|   |-- vitest/                   # Shared utility tests for heuristics, DTOs, feature flags
|   `-- fixtures/                 # Data snapshots aligning with Supabase seeds + mocks
|-- docs/operations/              # Runbooks, checklists, telemetry dashboards, automation backlog
|-- configs/
|   |-- turbo.json                # Pipeline orchestration definitions
|   |-- tsconfig.*.json           # Path aliases + strict TS configs
|   |-- tailwind.config.ts        # Token + plugin wiring shared across apps
|   `-- lint-staged.config.cjs    # Pre-commit enforcement for formatting/testing
|-- scripts/                      # CLI helpers (supabase impersonation, telemetry checks)
|-- .github/workflows/            # CI pipelines covering lint/test/build/migrations/storybook
|-- Dockerfile.ci                 # Reproducible CI image for pnpm + Supabase CLI
|-- package.json + pnpm-workspace.yaml # Workspace definitions & scripts
`-- README.md + CONTRIBUTING.md   # Overview, setup, coding standards, runbook links
```

<!-- anchor: directives-process -->
## 4. Directives & Strict Process

1. Enforce pnpm + Turbo workflows with lint/type/test/build gates per change set; no npm/yarn/bun usage allowed.
2. All Supabase interactions flow through `libs/supabase` typed clients and stored procedures; inline SQL/query builders in apps are prohibited.
3. Strict Row-Level Security plus Doppler-managed secrets and Flagsmith-gated rollouts are non-negotiable; impersonation tests + telemetry must accompany migrations touching access layers.
4. Every UI addition consumes `@caterkingapp/ui` primitives, honors gloves-friendly tap targets, and ships with Storybook/Chromatic coverage plus Playwright smoke flows across surfaces.
5. Feature work must emit structured OpenTelemetry traces/logs and respect undo/toast conventions; no silent failures or hidden long-running operations in Edge routes.
6. Artifacts (diagrams, specs, policies) must be committed as text (PlantUML/Mermaid/Markdown/OpenAPI) under `docs/` or `api/` and referenced by ADRs + iteration outputs to keep autonomous agents aligned.
7. Testing expectations: Vitest >=80% coverage on shared libs, Playwright for critical workflows per iteration, pgTAP for RLS/policy changes, and Supabase CLI seeds for deterministic fixtures.
8. Real-time resilience: document fallback banners, poll intervals, and offline guardrails in UI specs before releasing features reliant on Supabase Realtime.
9. Undo tokens, idempotency keys, and audit references must accompany all mutations; QA cannot sign off without verifying telemetry + audit entries appear in observability dashboards.
10. Release governance couples Supabase migrations, Flagsmith toggles, and Vercel deploys; every iteration deliverable includes explicit target files + validation steps so autonomous agents avoid cross-repo churn.