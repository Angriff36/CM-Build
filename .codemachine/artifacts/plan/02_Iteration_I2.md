<!-- anchor: iteration-2-plan -->

### Iteration 2: API & Realtime Foundation

- **Iteration ID:** `I2`
- **Goal:** Develop API contracts, realtime infrastructure, and basic endpoints for task operations.
- **Prerequisites:** I1
- **Tasks:**
  - **Task 2.1:**
    - **Task ID:** `I2.T1`
    - **Description:** Generate Sequence Diagrams (PlantUML) for task claim/completion flows.
    - **Agent Type Hint:** DiagrammingAgent
    - **Inputs:** Communication Patterns
    - **Input Files:** []
    - **Target Files:** docs/diagrams/sequence_task_flows.puml
    - **Deliverables:** PlantUML sequence diagrams.
    - **Acceptance Criteria:** Diagrams show UI, API, Supabase interactions accurately.
    - **Dependencies:** []
    - **Parallelizable:** Yes
  - **Task 2.2:**
    - **Task ID:** `I2.T2`
    - **Description:** Create OpenAPI Specification (YAML) for task and event endpoints.
    - **Agent Type Hint:** DocumentationAgent
    - **Inputs:** API Contract Style
    - **Input Files:** []
    - **Target Files:** api/openapi/tasks.yaml
    - **Deliverables:** OpenAPI YAML file.
    - **Acceptance Criteria:** Spec validates and defines GET /tasks, POST /tasks/:id/claim, etc.
    - **Dependencies:** []
    - **Parallelizable:** Yes
  - **Task 2.3:**
    - **Task ID:** `I2.T3`
    - **Description:** Set up realtime channel registry and basic subscription helpers.
    - **Agent Type Hint:** BackendAgent
    - **Inputs:** Communication Patterns
    - **Input Files:** []
    - **Target Files:** libs/supabase/src/realtime.ts, docs/diagrams/realtime_registry.md
    - **Deliverables:** Realtime helpers and registry document.
    - **Acceptance Criteria:** Channels scoped by company_id and documented.
    - **Dependencies:** []
    - **Parallelizable:** Yes
  - **Task 2.4:**
    - **Task ID:** `I2.T4`
    - **Description:** Implement API routes for task claiming and completion.
    - **Agent Type Hint:** BackendAgent
    - **Inputs:** OpenAPI spec from I2.T2
    - **Input Files:** api/openapi/tasks.yaml
    - **Target Files:** apps/prepchef/app/api/tasks/[id]/claim/route.ts, apps/prepchef/app/api/tasks/[id]/complete/route.ts
    - **Deliverables:** Next.js API routes with Supabase RPC.
    - **Acceptance Criteria:** Routes handle mutations and broadcast realtime.
    - **Dependencies:** [I2.T2, I2.T3]
    - **Parallelizable:** No
  - **Task 2.5:**
    - **Task ID:** `I2.T5`
    - **Description:** Integrate realtime into task dashboard.
    - **Agent Type Hint:** FrontendAgent
    - **Inputs:** Realtime registry
    - **Input Files:** docs/diagrams/realtime_registry.md
    - **Target Files:** apps/prepchef/app/tasks/page.tsx
    - **Deliverables:** Dashboard with live updates.
    - **Acceptance Criteria:** UI reflects realtime changes.
    - **Dependencies:** [I2.T4]
    - **Parallelizable:** No
  - **Task 2.6:**
    - **Task ID:** `I2.T6`
    - **Description:** Add undo mechanism for completions.
    - **Agent Type Hint:** FrontendAgent
    - **Inputs:** UI requirements
    - **Input Files:** libs/ui/src/components/
    - **Target Files:** apps/prepchef/components/UndoToast.tsx
    - **Deliverables:** Undo toast component.
    - **Acceptance Criteria:** Undo reverts within 5 minutes.
    - **Dependencies:** [I2.T5]
    - **Parallelizable:** Yes
