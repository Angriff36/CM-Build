<!-- anchor: system-architecture-blueprint -->
# System Architecture Blueprint: CaterKing

**Version:** 1.0
**Date:** 2025-12-10
**Generated By:** Structural_Data_Architect

<!-- anchor: 1-introduction-goals -->
## 1. Introduction & Goals

*   **1.1. Project Vision:** CaterKing delivers a unified kitchen management nervous system that keeps prep teams, managers, and owners synchronized inside a single multi-tenant workspace.
    It transforms handwritten prep sheets and fragmented chat updates into real-time task boards backed by typed Supabase contracts.
    The platform standardizes recipes, methods, and task states so that every surface, from gloved tablets to kiosk displays, shows the same source of truth.
    Vision success is defined by frictionless adoption inside loud, messy kitchens where immediacy, clarity, and tenant isolation cannot be compromised.
    The architecture therefore favors deterministic flows, guard-railed contracts, and a modular monolith that grows without fragmentation.

*   **1.2. Key Objectives:**
    - Deliver responsive task dashboards that reflect claim, combine, and completion actions with sub-150ms perceived latency across PrepChef, CaterKing Lite, Admin CRM, and wall displays.
    - Maintain strict multi-tenant isolation enforced by Supabase Row-Level Security so that every RPC, realtime channel, and storage asset is scoped to company_id.
    - Provide opt-in heuristic task consolidation that leverages shared normalization utilities while keeping human approval, audit tracking, and undo safety rails.
    - Expose recipes, methods, and training media inside tap-first drawers without forcing navigation context switches or duplicate data fetches.
    - Support staff role claiming, manager assignments, and owner governance through a single RBAC contract and shared access guard modules.
    - Streamline admin workflows for uploading media, editing recipes, and configuring events by leaning on shared UI primitives and typed forms.
    - Keep telemetry, feature flags, and deployment governance centralized so experimentation never breaks deterministic contracts.
    - Guarantee that kiosk displays and passive monitors operate on summarized queries or cached snapshots without overloading realtime fan-out limits.
    - Ensure every mutation publishes audit logs and undo tokens so rollbacks remain possible even during peak production windows.
    - Plan for expansion to multiple locations, analytics pipelines, and future notification channels without reworking the foundational structure.

*   **1.3. Scope:** This blueprint covers the static topology of applications, libraries, Supabase assets, and structural contracts that compose the CaterKing suite.
    It includes the hierarchy of Turbo-managed apps, shared libraries, database schema, realtime buses, feature flag adapters, and observability plumbing.
    Operational runbooks, behavioral sequencing, and runtime scaling tactics fall outside this document and remain the purview of behavior and ops architects.
    The scope explicitly addresses staff/mobile PWAs, admin dashboards, kiosk screens, media handling, and Supabase-backed data domains as described in the foundation.
    Out-of-scope capabilities such as inventory, analytics, and supplier integrations are acknowledged only to reserve schema capacity and boundary seams.

*   **1.4. Key Assumptions:** All assumptions inherit directly from `01_Blueprint_Foundation.md` unless annotated otherwise.
    - Heuristic task similarity relies on deterministic fuzzy matching plus ingredient normalization, wrapped behind feature flags for tuning without redeploys.
    - Wall-mounted displays tolerate up to 15 seconds of staleness and will gracefully shift to short polling whenever realtime channels degrade.
    - Media uploads are capped at 500MB per asset, flow through Supabase signed URLs, and trigger background transcoding jobs without blocking task execution.
    - Recipe and method edits use optimistic locking with version incrementation; no multi-user live collaboration is provided in this release.
    - Undo actions apply to task claiming and completion within five minutes, storing undo_token columns referenced by realtime payloads.
    - Notifications remain in-app for MVP, while push/SMS/email connectors are stubbed via the notification dispatcher abstraction for future releases.
    - Offline operation is intentionally unsupported; clients fail closed with connective banners while preserving UI clarity.
    - Doppler-managed secrets remain the single configuration spine, and no `.env` artifacts or ad-hoc secret injection is permitted anywhere in the repo.
    - Supabase remains the canonical persistence tier; no alternate databases or caches are introduced until latency budgets demonstrate the need.
    - All architectural decisions documented here respect the large-scale classification and therefore avoid microservice sprawl, duplicate logic, or siloed contracts.

<!-- anchor: 2-architectural-drivers -->
## 2. Architectural Drivers

*   **2.1. Functional Requirements Summary:** The platform must orchestrate every phase of the prep workflow inside a shared real-time surface.
    - Task management spans viewing, claiming, completing, assigning, undoing, and monitoring statuses across multiple events simultaneously.
    - Task consolidation suggestions highlight similar prep steps, compute normalized units, and store combined group metadata that downstream clients can expand.
    - Multi-event coordination lets managers inspect event-specific prep lists, staff assignments, and aggregated cross-event workload insights.
    - Recipes, methods, and skill documentation provide contextual reference drawers with video, imagery, and structured steps accessible without leaving the workflow.
    - Role-aware permissions enforce what staff, managers, event leads, and owners can see or mutate, ensuring operations and governance remain distinct yet coordinated.
    - Media upload, storage, and retrieval pipelines support high-quality assets for training and instructions without blocking day-to-day prep execution.
    - Kiosk displays, admin dashboards, and lightweight CaterKing apps offer trimmed experiences that still consume shared contracts so staff never see conflicting states.

*   **2.2. Non-Functional Requirements (NFRs):** Structure is heavily influenced by latency, isolation, security, and maintainability demands.
    - Real-time freshness: Supabase Realtime, optimistic UI updates, and idempotent RPCs keep perceived latency below 150ms for state changes.
    - Availability and resilience: Clients degrade to polling, background jobs retry, and telemetry surfaces health so operators can trust the system mid-service.
    - Multi-tenancy and RLS: Every table, bucket, and channel is scoped to company_id, and the libs/supabase layer guards context injection to avoid drift.
    - Scalability: Turbo monorepo modules allow rapid iteration while Supabase and Vercel scale horizontally; future multi-location needs are anticipated in naming.
    - Security: Supabase Auth, Doppler-managed secrets, and RLS policies ensure compartmentalization, while audit logs record every critical action.
    - UX consistency: Shared UI kits, typed hooks, and feature-flag wrappers prevent divergence between prepfloor PWAs, admin consoles, and kiosk views.
    - Observability: OpenTelemetry instrumentation, structured logging, and health snapshots supply enough data for chaos drills and fast diagnosis.

*   **2.3. Constraints & Preferences:** The foundation imposes explicit boundaries that this blueprint honors.
    - Architectural style is locked to a modular monolithic Turbo repo, so all decomposition happens via libraries and Supabase schemas rather than microservices.
    - Next.js 15 with App Router, React Server Components, Tailwind, ShadCN, and React Query form the only approved frontend stack; no alternate routers or state managers.
    - Supabase, Vercel, Doppler, Flagsmith (or equivalent), pnpm 8+, Turbo 2+, Vitest, Playwright, and Storybook compose the non-negotiable tooling baseline.
    - Supabase Postgres carries every domain entity with JSONB columns for flexible recipe payloads; direct SQL from app folders is forbidden in favor of RPCs.
    - Secrets cannot exist outside Doppler contexts; environment configuration must be deterministic and codified via templates and `vercel.json`.
    - Testing gates require lint, typecheck, coverage, storybook accessibility, and contract verification before merges; architecture must keep these pipelines practical.
    - Feature work must ship behind typed feature flags with telemetry coverage, so components include flag contexts even when functionality is disabled.
    - Edge-compatible routes must remain pure; compute-heavy steps move into Supabase Functions, leaving Next.js server actions lean and deterministic.

<!-- anchor: 3-proposed-architecture -->
## 3. Proposed Architecture (Structural View)

*   **3.1. Architectural Style:** The solution follows the mandated modular monolithic Turbo repo style where every business capability lives inside bounded libraries while Next.js apps merely orchestrate composition.
    Shared libraries encapsulate domain models, UI primitives, and Supabase adapters so that the structure remains coherent and future multi-location expansion is achieved without service sprawl.
    The architecture isolates compute-heavy logic inside Supabase Functions, keeps API routes thin, and upholds deterministic flows required for RLS enforcement and optimistic collaboration.
    This style also keeps developer workflows fast because pnpm + Turbo reuse caches while guaranteeing changesets propagate predictably across the suite.

*   **3.2. Technology Stack Summary:** The table below restates the "Standard Kit" from the foundation so every structural facet aligns with approved tooling and hosting targets.

| Layer | Technology | Notes |
| --- | --- | --- |
| Architectural Style | Modular monolithic Turbo repo (Next.js + Supabase) | Apps orchestrate via shared libraries, avoiding microservice fragmentation. |
| Frontend Applications | Next.js 15 App Router, React 18 Server Components, Tailwind CSS, ShadCN via `@codemachine/ui` | PrepChef, CaterKing Lite, Admin CRM, and Display apps reuse identical primitives. |
| State Management | React Server Components + React Query + Supabase Realtime | Initial fetch via server components, client cache + realtime maintain freshness. |
| Shared Libraries | `libs/ui`, `libs/shared`, `libs/supabase`, `libs/rag`, `libs/mcp` | Typed exports only, design system + domain contracts + data helpers. |
| Backend Logic | Next.js API routes (Edge/Node) + Supabase SQL/RPC + Supabase Edge Functions | Mutations flow through stored procedures, idempotency tokens, and optional compute workers. |
| Database | Supabase Postgres with JSONB columns and full RLS | Migrations, policies, and generated types live under `supabase/`. |
| Storage & Media | Supabase Storage buckets + Functions for transcoding + CDN distribution | Handles recipe images, training videos, thumbnails, and metadata persistence. |
| Secrets & Config | Doppler-managed secrets + Vercel config + Flagsmith feature flags | No `.env` files; feature toggles typed and exposed through shared context. |
| Realtime & Messaging | Supabase Realtime channels (`company:{company_id}:{entity}`) | Fan-out for tasks, events, recipes, audit logs, and undo flows. |
| Dev Tooling & CI | pnpm 8+, Turbo 2+, Vitest, Playwright, Storybook/Chromatic, Supabase CLI | Mandatory pipelines for linting, testing, schema verification, and visual regressions. |
| Hosting | Vercel (apps + API) + Supabase (DB/Auth/Storage/Functions) + optional Docker for CI | Edge-friendly deployments with rollback hooks, telemetry, and Doppler injection. |

*   **3.3. System Context Diagram (C4 Level 1):**
    *   **Description:** The context view highlights how CaterKing unifies kitchen staff, managers, event leads, owners, kiosk observers, and admin operators around a single Supabase-backed workspace hosted on Vercel.
        Supabase Platform, Doppler, Flagsmith, and the observability provider act as external systems that supply persistence, configuration, feature gating, and telemetry.
        Every human persona connects through hardened PWAs or desktops, while wall displays consume read-only feeds that keep the kitchen aware without manual refreshes.
        Tenant isolation is enforced at the platform boundary, and all channel names plus storage objects stay scoped to company identifiers to keep the topology compliant.
    *   **Diagram (PlantUML):**
        ~~~plantuml
        @startuml
        !include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Context.puml
        ' -----------------------------------------------------------------------------
        ' CaterKing Context Diagram - captures personas, platform, and external services.
        ' -----------------------------------------------------------------------------
        LAYOUT_WITH_LEGEND()
        ' -----------------------------------------------------------------------------
        AddElementTag("tenant", $fontColor="Black", $bgColor="Cornsilk", $borderColor="Goldenrod")
        AddElementTag("platform", $fontColor="White", $bgColor="MidnightBlue", $borderColor="White")
        AddElementTag("external", $fontColor="Black", $bgColor="LightGray", $borderColor="DimGray")
        AddRelTag("https", $textColor="RoyalBlue")
        AddRelTag("event-stream", $textColor="DarkGreen")
        ' -----------------------------------------------------------------------------
        Person(staff_person, "Kitchen Staff", "Role: staff", "Uses PrepChef mobile PWA for realtime prep execution.") <<tenant>>
        Person(manager_person, "Manager", "Role: manager", "Assigns and audits tasks, monitors cross-event workload.") <<tenant>>
        Person(eventlead_person, "Event Lead", "Role: event lead", "Coordinates event-specific prep and approvals.") <<tenant>>
        Person(owner_person, "Business Owner", "Role: owner", "Maintains recipes, methods, and staff directories.") <<tenant>>
        Person(trainee_person, "Trainee", "Role: staff/trainee", "Consumes methods and skill documentation for onboarding.") <<tenant>>
        Person(kiosk_observer, "Wall Display Observer", "Kitchen crew", "Glances at kiosk displays with passive awareness.") <<tenant>>
        Person(admin_person, "Admin Operator", "HQ staff", "Configures Doppler secrets, flags, and compliance artifacts.") <<tenant>>
        ' -----------------------------------------------------------------------------
        note right of staff_person
          Uses gloves-friendly PrepChef interface with offline awareness banners.
          Relies on undo prompts after completion events for quick corrections.
        end note
        note right of manager_person
          Balances multiple concurrent events and stations.
          Reviews heuristic combination suggestions and approves merges.
        end note
        note right of kiosk_observer
          Observes high-level status counts without interacting.
          Works even when realtime falls back to polling snapshots.
        end note
        ' -----------------------------------------------------------------------------
        System_Boundary(caterking_boundary, "CaterKing Platform Boundary") {
          System(caterking_suite, "CaterKing Apps & APIs", "Next.js 15 + pnpm Turbo repo", "Shared UI and API layer orchestrating Supabase-backed workflows.") <<tenant>>
        }
        ' -----------------------------------------------------------------------------
        System_Ext(supabase_platform, "Supabase Platform", "Postgres + Auth + Storage + Realtime", "Managed database, auth, storage, and realtime fabric for all tenants.") <<platform>>
        System_Ext(vercel_platform, "Vercel Edge Network", "Deployment Platform", "Hosts the Next.js apps and server actions globally.") <<external>>
        System_Ext(flagsmith_service, "Flagsmith", "Feature Flag Service", "Controls rollout of heuristic combinations and experimental UI toggles.") <<external>>
        System_Ext(doppler_service, "Doppler", "Secrets Management", "Delivers environment-scoped secrets with audit trails.") <<external>>
        System_Ext(observability_stack, "Observability Provider", "OpenTelemetry + Log sink", "Collects structured logs, traces, and metrics for ops.") <<external>>
        System_Ext(media_cdn, "Supabase Storage CDN", "Media Delivery", "Serves recipe imagery, method videos, and thumbnails with caching.") <<external>>
        ' -----------------------------------------------------------------------------
        note right of supabase_platform
          Provides Postgres persistence, Auth JWT issuance, Storage buckets, and Realtime fan-out.
          Enforces RLS policies to keep company data segregated and auditable.
        end note
        note right of flagsmith_service
          Evaluates feature flags server-side and client-side via shared adapters.
          Logs exposures for later analysis in observability pipelines.
        end note
        note right of doppler_service
          Maintains source of truth for Supabase keys, service roles, and runtime secrets.
          Integrates with CI/CD so deploys fail if required secrets are absent.
        end note
        ' -----------------------------------------------------------------------------
        Rel(staff_person, caterking_suite, "Claims tasks, views recipe drawers, reads combine suggestions.", "Mobile PWA / HTTPS") <<https>>
        Rel(manager_person, caterking_suite, "Assigns tasks, approves combinations, monitors dashboards.", "Web app / HTTPS") <<https>>
        Rel(eventlead_person, caterking_suite, "Curates event prep lists, resolves conflicts, triggers undo flows.", "Tablet / HTTPS") <<https>>
        Rel(owner_person, caterking_suite, "Maintains recipes and methods, manages staff roles, uploads media.", "Desktop / HTTPS") <<https>>
        Rel(trainee_person, caterking_suite, "Accesses method viewer, video tutorials, and skill checklists.", "Side panel / HTTPS") <<https>>
        Rel(kiosk_observer, caterking_suite, "Views passive task states, urgent alerts, and presence heatmaps.", "Read-only display / WebSocket")
        Rel(admin_person, caterking_suite, "Runs admin CRM, inspects audit logs, tunes heuristics via feature flags.", "Desktop / HTTPS")
        ' -----------------------------------------------------------------------------
        Rel(caterking_suite, supabase_platform, "Persists tasks, events, recipes, audit logs, combined groups.", "Supabase client / RPC") <<event-stream>>
        Rel(caterking_suite, media_cdn, "Retrieves media assets and thumbnails for recipes/methods.", "Signed URLs / CDN")
        Rel(caterking_suite, vercel_platform, "Deploys server components and API routes.", "CI/CD pipes")
        Rel(caterking_suite, flagsmith_service, "Evaluates feature flags server-side and client-side.", "SDK calls")
        Rel(caterking_suite, doppler_service, "Pulls secrets and config at build and runtime.", "Doppler CLI / API")
        Rel(caterking_suite, observability_stack, "Pushes traces, metrics, structured logs.", "OTLP / HTTPS")
        Rel(supabase_platform, kiosk_observer, "Broadcasts realtime summaries powering displays.", "Supabase Realtime")
        ' -----------------------------------------------------------------------------
        Rel_Back(supabase_platform, caterking_suite, "Auth tokens, realtime events, storage notifications.", "Realtime websockets") <<event-stream>>
        Rel_Back(media_cdn, caterking_suite, "Upload acknowledgements, processing hooks.", "Storage webhooks")
        Rel(flagsmith_service, admin_person, "Dashboard for toggles & experiments.", "Web console")
        Rel(doppler_service, admin_person, "Secret rotations and approvals.", "Web console")
        Rel(observability_stack, admin_person, "Alerting, dashboards, and traces for ops review.", "Web console")
        Rel(vercel_platform, admin_person, "Monitors deployments, rollbacks, and environment promotion.", "Vercel dashboard")
        ' -----------------------------------------------------------------------------
        SHOW_LEGEND()
        ' -----------------------------------------------------------------------------
        @enduml
        ~~~

*   **3.4. Container Diagram (C4 Level 2):**
    *   **Description:** The container view decomposes the suite into Next.js applications, shared libraries, Supabase stores, realtime buses, and operational services mandated by the foundation.
        Each application container depends on shared libraries for UI, domain models, and Supabase access, ensuring no logic duplication occurs inside app directories.
        Supabase Postgres, Storage, Realtime, and Functions provide cohesive backend services, while Doppler, Flagsmith, and the observability harness enrich every container with flags, secrets, and telemetry.
        The structure supports future surfaces (e.g., React Native) because hooks and adapters stay inside libraries rather than app folders, delivering a scalable static layout.
    *   **Diagram (PlantUML):**
        ~~~plantuml
        @startuml
        !include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Container.puml
        ' =============================================================================
        ' CaterKing Container Diagram - Next.js apps, shared libs, Supabase services.
        ' =============================================================================
        LAYOUT_WITH_LEGEND()
        ' =============================================================================
        AddElementTag("app", $fontColor="White", $bgColor="DarkSlateBlue", $borderColor="Lavender")
        AddElementTag("lib", $fontColor="Black", $bgColor="Moccasin", $borderColor="Goldenrod")
        AddElementTag("service", $fontColor="White", $bgColor="DarkGreen", $borderColor="PaleGreen")
        AddElementTag("ops", $fontColor="Black", $bgColor="Gainsboro", $borderColor="DimGray")
        AddRelTag("rsc", $textColor="DarkCyan")
        AddRelTag("rpc", $textColor="DarkMagenta")
        ' =============================================================================
        System_Boundary(caterking_suite, "CaterKing Suite") {
          Container(app_prepchef, "apps/prepchef", "Next.js 15 (RSC + React Query)", "Mobile-first staff PWA for prep execution.") <<app>>
          Container(app_caterking, "apps/caterking", "Next.js 15 (RSC)", "Lightweight operations app for smaller teams.") <<app>>
          Container(app_admin, "apps/admin-crm", "Next.js 15 (SSR + hydration)", "Desktop admin and manager dashboard for events, staff, and recipes.") <<app>>
          Container(app_display, "apps/display", "Next.js 15 (ISR + polling)", "Passive kiosk/wall display for status boards and alerts.") <<app>>
          Container(app_api, "Next.js API Routes & Server Actions", "Edge/Node runtimes", "REST-ish endpoints and mutations calling Supabase RPCs.") <<app>>
        }
        ' =============================================================================
        System_Boundary(shared_libs, "Shared Libraries") {
          Container(lib_ui, "libs/ui", "TypeScript + Tailwind + ShadCN", "Design system, typography tokens, gloves-friendly components.") <<lib>>
          Container(lib_shared, "libs/shared", "TypeScript Domain Models + Zod", "Domain schemas, validators, heuristic utilities, enums.") <<lib>>
          Container(lib_supabase, "libs/supabase", "Typed Supabase Client Wrapper", "RLS-safe client factory, RPC helpers, realtime adapters.") <<lib>>
          Container(lib_rag, "libs/rag", "Python ingestion utilities", "Document ingestion + semantic prep for RAG tasks (future).") <<lib>>
          Container(lib_mcp, "libs/mcp", "Tooling/Integrations", "MCP + automation helpers for integration scenarios.") <<lib>>
        }
        ' =============================================================================
        System_Boundary(supabase_services, "Supabase Services") {
          ContainerDb(db_postgres, "Supabase Postgres", "Managed Postgres + RLS", "Stores companies, users, events, tasks, recipes, audit logs.") <<service>>
          ContainerDb(db_storage, "Supabase Storage", "Object Storage + CDN", "Holds media assets, method videos, thumbnails per company.") <<service>>
          Container(queue_realtime, "Supabase Realtime Channels", "Phoenix websockets", "Broadcasts change feeds per `company:{company_id}:{entity}`.") <<service>>
          Container(queue_functions, "Supabase Edge Functions", "Deno-based functions", "Executes heuristics, media processing callbacks, scheduled jobs.") <<service>>
          Container(materialized_views, "Display Summaries", "Materialized Views + Cron", "Pre-computed stats for kiosk display fallbacks.") <<service>>
        }
        ' =============================================================================
        Container(flagsmith_adapter, "Feature Flag Adapter", "Flagsmith SDK wrapper", "Server + client evaluation of feature flags, exposures, and variants.") <<ops>>
        Container(doppler_cli, "Doppler Runtime Config", "Doppler CLI + Templates", "Injects secrets into Vercel and Supabase environments.") <<ops>>
        Container(observability_adapter, "Observability Stack Adapter", "OpenTelemetry + Log shipping", "Collects traces, logs, metrics for pipelines and alerting.") <<ops>>
        Container(notification_dispatcher, "Notification Dispatcher", "In-app toasts + future push connectors", "Handles toasts, undo prompts, and future channels.") <<ops>>
        ' =============================================================================
        note right of shared_libs
          Libraries enforce named exports only; no defaults.
          Apps may only import via @codemachine/* aliases.
        end note
        note bottom of supabase_services
          Every table carries company_id and RLS policies.
          Cron jobs refresh kiosk summaries and archive audit logs.
        end note
        note left of caterking_suite
          All Next.js apps share server components and typed hooks.
          Each app can be filtered via turbo build --filter <app>.
        end note
        ' =============================================================================
        Rel(app_prepchef, lib_ui, "Consumes gloves-friendly design primitives.", "RSC composition") <<rsc>>
        Rel(app_prepchef, lib_shared, "Uses task enums, DTOs, heuristics.", "Type imports") <<rsc>>
        Rel(app_prepchef, lib_supabase, "Queries Supabase Postgres + Realtime.", "Supabase client")
        Rel(app_prepchef, app_api, "Invokes server actions for claim/complete/combine.", "HTTPS / fetch")
        Rel(app_prepchef, queue_realtime, "Subscribes to realtime task and recipe channels.", "Supabase Realtime websocket")
        Rel(app_prepchef, notification_dispatcher, "Publishes toasts + undo prompts.", "Client events")
        Rel(app_prepchef, observability_adapter, "Streams user interactions for telemetry.", "OTLP spans")
        ' =============================================================================
        Rel(app_caterking, lib_ui, "Shares simplified dashboards and components.", "RSC")
        Rel(app_caterking, lib_shared, "Reads event/task DTOs.", "Type imports")
        Rel(app_caterking, lib_supabase, "Uses shared queries + RPC helpers.", "Supabase client")
        Rel(app_caterking, queue_realtime, "Subscribes to aggregated event channels.", "Realtime websockets")
        Rel(app_caterking, notification_dispatcher, "Displays approval prompts and alerts.", "Client events")
        ' =============================================================================
        Rel(app_admin, lib_ui, "Leverages admin forms, tables, media uploaders.", "SSR + hydration")
        Rel(app_admin, lib_shared, "Validates recipes, methods, staff roles.", "Zod validators")
        Rel(app_admin, lib_supabase, "Executes RPC for staff assignment, recipe edits.", "Supabase client")
        Rel(app_admin, queue_functions, "Triggers Supabase functions for heavy heuristics.", "Function invocation")
        Rel(app_admin, db_storage, "Requests signed URLs for media uploads.", "Supabase storage API")
        Rel(app_admin, doppler_cli, "Coordinates secret rotations + environment setup.", "CLI / pipeline")
        Rel(app_admin, flagsmith_adapter, "Controls feature flag toggles + exposures.", "SDK / GraphQL")
        ' =============================================================================
        Rel(app_display, lib_ui, "Renders passive tiles + summary components.", "ISR / streaming")
        Rel(app_display, lib_shared, "Uses summary DTOs + role enums.", "Type imports")
        Rel(app_display, lib_supabase, "Reads summary endpoints + Realtime snapshots.", "Supabase client")
        Rel(app_display, materialized_views, "Fetches precomputed digests for fallback mode.", "SQL polling")
        Rel(app_display, queue_realtime, "Listens to display channels when realtime available.", "Realtime websockets")
        ' =============================================================================
        Rel(app_api, lib_shared, "Validates payloads + enforces schema_version.", "Type usage")
        Rel(app_api, lib_supabase, "Calls RPC, checks RLS, wraps idempotency tokens.", "Supabase service role client") <<rpc>>
        Rel(app_api, db_postgres, "Executes RPC/stored procedures for tasks, recipes, roles.", "RPC / SQL")
        Rel(app_api, queue_functions, "Dispatches heavy heuristics + media processing to Supabase functions.", "Function calls")
        Rel(app_api, queue_realtime, "Pushes realtime events via Postgres triggers.", "Notify / Broadcast")
        Rel(app_api, db_storage, "Issues signed URLs + handles callbacks.", "Storage API")
        Rel(app_api, flagsmith_adapter, "Reads flags to guard endpoints + responses.", "SDK")
        Rel(app_api, observability_adapter, "Emits structured logs + traces.", "OTLP")
        ' =============================================================================
        Rel(lib_ui, lib_shared, "Respects domain naming, status tokens, role constants.", "Type imports")
        Rel(lib_shared, lib_supabase, "Supplies typed DTOs + validators to RPC layer.", "Type + helper usage")
        Rel(lib_supabase, db_postgres, "Executes typed queries + RPC calls.", "Supabase client")
        Rel(lib_supabase, queue_realtime, "Subscribes/unsubscribes to channels per company.", "Realtime client")
        Rel(lib_rag, db_storage, "Ingests documents for knowledge base (future).", "Signed URLs")
        Rel(lib_mcp, app_admin, "Provides connectors for MCP-powered workflows.", "Automation pipeline")
        ' =============================================================================
        Rel(db_postgres, queue_realtime, "Triggers broadcast via Postgres changes.", "Replication slots")
        Rel(db_postgres, materialized_views, "Feeds view refresh jobs for kiosk summaries.", "SQL refresh")
        Rel(db_storage, queue_functions, "Invokes transcoding + metadata extraction after upload.", "Storage webhook")
        Rel(queue_functions, db_postgres, "Writes heuristic results + audit logs.", "RPC / SQL")
        Rel(queue_functions, queue_realtime, "Publishes summary updates after processing.", "Realtime push")
        ' =============================================================================
        Rel(flagsmith_adapter, observability_adapter, "Logs flag exposures + errors for auditing.", "Telemetry stream")
        Rel(observability_adapter, admin_person, "Surfaces dashboards + alerts.", "Grafana/Log UI")
        Rel(notification_dispatcher, app_prepchef, "Delivers toasts + undo prompts into UI component tree.", "Client events")
        Rel(notification_dispatcher, app_caterking, "Mirrors notifications for managers.", "Client events")
        Rel(notification_dispatcher, app_admin, "Notifies admin of slow fetches or policy violations.", "Client events")
        Rel(doppler_cli, app_api, "Provides runtime secrets for Supabase + Flagsmith + storage keys.", "CI/CD injection")
        ' =============================================================================
        SHOW_LEGEND()
        ' =============================================================================
        @enduml
        ~~~

*   **3.5. Component Diagram (C4 Level 3 - for a key Container):**
    *   **Description:** The component view zooms into `apps/prepchef`, the primary staff PWA, to illustrate how server components, client hooks, realtime adapters, and mutation services coordinate task flows.
        Components such as the Task Board, Recipe Drawer, Undo Controller, Presence Tracker, and Telemetry Collector all depend on shared libraries plus Supabase RPC wrappers.
        Feature flag and access guard contexts gate experimental heuristics and RBAC logic, while edge-safe mutation handlers enforce idempotent tokens and dispatch audit events.
        This breakdown clarifies where new staff-facing capabilities must land so behavior architects or engineers avoid bypassing canonical entry points.
    *   **Diagram (PlantUML):**
        ~~~plantuml
        @startuml
        !include https://raw.githubusercontent.com/plantuml-stdlib/C4-PlantUML/master/C4_Component.puml
        ' =============================================================================
        ' apps/prepchef Component Diagram - server components, hooks, adapters.
        ' =============================================================================
        LAYOUT_WITH_LEGEND()
        ' =============================================================================
        AddElementTag("ui", $fontColor="Black", $bgColor="BlanchedAlmond", $borderColor="DarkGoldenrod")
        AddElementTag("service", $fontColor="White", $bgColor="DarkSlateGray", $borderColor="LightCyan")
        AddElementTag("adapter", $fontColor="White", $bgColor="DarkOliveGreen", $borderColor="DarkSeaGreen")
        AddElementTag("external", $fontColor="Black", $bgColor="LightGray", $borderColor="DimGray")
        AddRelTag("ui-flow", $textColor="DarkOrange")
        AddRelTag("rpc-flow", $textColor="DarkMagenta")
        ' =============================================================================
        Container_Boundary(prepchef_app, "apps/prepchef (Next.js PWA)") {
          Component(server_entry, "Server Component Shell", "React Server Component", "Fetches initial tasks/events via libs/supabase typed queries.") <<ui>>
          Component(task_board, "Task Board UI", "Client Component", "Renders grouped tasks, statuses, urgency tags, and claim buttons.") <<ui>>
          Component(filter_panel, "Filter & Scope Panel", "Client Component", "Applies event/station/type filters and persists choices.") <<ui>>
          Component(status_buttons, "Status Control Cluster", "Client Component", "Claim/complete/unclaim toggles with gloves-friendly states.") <<ui>>
          Component(recipe_drawer, "Recipe & Method Drawer", "Client Component", "Streams instructions, images, and videos from Supabase Storage.") <<ui>>
          Component(task_group_indicator, "Task Combine Indicator", "Client Micro-component", "Shows similarity suggestions and approvals.") <<ui>>
          Component(notification_toast, "Notification & Undo Toasts", "Client Service", "Displays confirmations, errors, undo options for 5 minutes.") <<service>>
          Component(react_query_layer, "React Query Cache", "TanStack Query", "Caches datasets, invalidates on realtime confirms, drives optimistic UI.") <<adapter>>
          Component(realtime_adapter, "Realtime Subscription Adapter", "Shared Hook", "Manages Supabase Realtime channels scoped to company_id.") <<adapter>>
          Component(mutation_service, "Task Mutation Service", "RPC Command Bus", "Wraps claim_task / complete_task / combine_tasks RPCs with idempotency tokens.") <<service>>
          Component(undo_controller, "Undo Controller", "Client Utility", "Stores undo tokens per action and replays revert RPC when triggered.") <<service>>
          Component(presence_tracker, "Presence & Heartbeat Tracker", "Client Utility", "Publishes focus, active task, and device info to presence channels.") <<adapter>>
          Component(media_viewer, "Media Viewer Panel", "Client Component", "Loads signed URLs, tracks buffering, handles fallback thumbnails.") <<ui>>
          Component(access_guard, "Access Guard Context", "RBAC Context", "Reads Supabase JWT role claims and filters UI/commands accordingly.") <<adapter>>
          Component(flag_gateway, "Feature Flag Gateway", "Flagsmith Client", "Evaluates flags for heuristics, UI toggles, and exposures.") <<adapter>>
          Component(telemetry_collector, "Telemetry Collector", "OpenTelemetry Adapter", "Records interactions, errors, exposure metrics, offline banners.") <<service>>
          Component(auth_client, "Supabase Auth Client", "Session Adapter", "Manages JWT, company_id injection, and refresh tokens.") <<adapter>>
          Component(edge_action_client, "Edge Action Client", "Next.js Server Action Caller", "Executes server actions for low-latency mutations on Edge runtime.") <<service>>
          Component(device_manager, "Device Capability Manager", "Utility", "Detects orientation, kiosk locks, offline indicators, and adaptation hints.") <<service>>
          Component(error_boundary, "Resilient Error Boundary", "Guard Component", "Captures runtime failures, surfaces fail-closed banners, prevents loops.") <<ui>>
          Component(localization_layer, "Localization & Formatting Layer", "Utility", "Handles unit conversions, measurement formatting, and locale output.") <<service>>
        }
        ' =============================================================================
        Component_Ext(lib_shared_models, "libs/shared Models", "TypeScript Library", "Domain DTOs, enums, heuristic utilities, Zod validators.") <<external>>
        Component_Ext(lib_ui_primitives, "libs/ui Primitives", "Component Library", "ShadCN/Tailwind atoms used across tasks, drawers, toasts.") <<external>>
        Component_Ext(lib_supabase_client, "libs/supabase Client", "TypeScript Library", "Typed Supabase client factory + RPC helpers + realtime hooks.") <<external>>
        Component_Ext(flagsmith_service, "Flagsmith Service", "Feature Flag Platform", "External service evaluating flags and returning variants.") <<external>>
        Component_Ext(doppler_runtime, "Doppler Config", "Secrets Management", "Provides Supabase URLs, anon keys, service roles via environment injection.") <<external>>
        Component_Ext(supabase_rpc_layer, "Supabase RPC Layer", "Postgres Functions", "`claim_task`, `complete_task`, `combine_tasks`, `log_audit_event`.") <<external>>
        Component_Ext(supabase_storage, "Supabase Storage", "Object Storage", "Media bucket delivering signed URLs for recipes and methods.") <<external>>
        Component_Ext(supabase_realtime, "Supabase Realtime Channel", "Realtime Service", "Channel per company/entity broadcasting delta payloads.") <<external>>
        Component_Ext(observability_stack, "Observability Stack", "OpenTelemetry Exporter", "Collects spans/logs, routes to Logflare/Datadog.") <<external>>
        Component_Ext(notification_dispatcher_ext, "Notification Dispatcher", "Client/Server Service", "Centralized toast + undo infrastructure shared by apps.") <<external>>
        Component_Ext(presence_channel, "Presence Channel", "Supabase Channel", "Tracks device heartbeat and focus state per user.") <<external>>
        Component_Ext(media_transcode_queue, "Media Processing Queue", "Supabase Function", "Handles thumbnail generation + status updates for assets.") <<external>>
        Component_Ext(feature_flag_registry, "Feature Flag Registry", "Metadata Store", "Defines flag keys, defaults, targeting rules, telemetry tags.") <<external>>
        ' =============================================================================
        note right of server_entry
          Server components fetch curated datasets via libs/supabase.
          They stream partial trees so initial payload remains small.
        end note
        note right of react_query_layer
          Maintains normalized cache keyed by company, event, and station filters.
          Reconciles optimistic state using realtime confirmations.
        end note
        note right of mutation_service
          All mutations include actor_id, undo_token, and idempotency key.
          Publishes telemetry events + triggers audit log RPCs.
        end note
        note bottom of realtime_adapter
          Auto-resubscribes after connectivity drops.
          Applies feature-flagged fallbacks to switch into polling mode.
        end note
        note left of flag_gateway
          Evaluates on server render and hydrates context for clients.
          Exposures sent to telemetry collector for compliance tracking.
        end note
        ' =============================================================================
        Rel(server_entry, lib_shared_models, "Uses DTOs + validators to shape server responses.", "Type imports")
        Rel(server_entry, lib_supabase_client, "Executes typed queries with company context.", "Server fetch")
        Rel(server_entry, lib_ui_primitives, "Composes layout wrappers and skeletons.", "RSC composition")
        Rel(server_entry, auth_client, "Reads session claims to prefilter data.", "Server context")
        Rel(server_entry, flag_gateway, "Evaluates gating for heuristics before streaming UI.", "Server flag evaluation")
        ' =============================================================================
        Rel(task_board, react_query_layer, "Renders from cached queries + mutations.", "Client hooks") <<ui-flow>>
        Rel(task_board, status_buttons, "Contains status controls for each row.", "Props/Events")
        Rel(task_board, filter_panel, "Subscribes to filter selections + query params.", "Context events")
        Rel(task_board, realtime_adapter, "Receives realtime delta updates.", "Websocket stream")
        Rel(task_board, device_manager, "Adapts layout for orientation + kiosk locks.", "Utility hints")
        Rel(task_board, localization_layer, "Formats quantities, units, timers.", "Utility calls")
        Rel(task_board, notification_toast, "Triggers toasts on completion or failure.", "Events")
        Rel(task_board, recipe_drawer, "Opens drawer for instructions + media.", "Component interaction")
        ' =============================================================================
        Rel(status_buttons, mutation_service, "Calls claim/complete/unclaim RPCs.", "Mutation dispatch") <<rpc-flow>>
        Rel(status_buttons, undo_controller, "Registers undo tokens after success.", "Callback")
        Rel(status_buttons, telemetry_collector, "Logs button taps + outcomes.", "Event instrumentation")
        Rel(status_buttons, access_guard, "Checks permissions before enabling actions.", "RBAC guard")
        ' =============================================================================
        Rel(task_group_indicator, flag_gateway, "Shows heuristics only when flag enabled.", "Flag context")
        Rel(task_group_indicator, mutation_service, "Triggers combine approval RPC.", "Mutation event")
        Rel(task_group_indicator, telemetry_collector, "Logs acceptance or dismissal of suggestions.", "Event log")
        ' =============================================================================
        Rel(filter_panel, react_query_layer, "Invalidates caches when filters change.", "Cache events")
        Rel(filter_panel, device_manager, "Persists per-device filter defaults.", "Storage hints")
        Rel(filter_panel, telemetry_collector, "Records filter usage + time to find tasks.", "Analytics event")
        ' =============================================================================
        Rel(recipe_drawer, media_viewer, "Embeds signed media players + step list.", "Component composition")
        Rel(recipe_drawer, lib_shared_models, "Maps versioned recipes to UI steps.", "Type usage")
        Rel(recipe_drawer, supabase_storage, "Loads signed URLs + thumbnails per media.", "HTTP GET")
        Rel(recipe_drawer, realtime_adapter, "Updates instructions if recipe version increments.", "Realtime stream")
        Rel(recipe_drawer, telemetry_collector, "Captures dwell time + step navigation.", "Analytics event")
        Rel(recipe_drawer, notification_toast, "Warns when media processing still pending.", "Toast event")
        Rel(recipe_drawer, media_transcode_queue, "Receives status updates for uploads via Realtime.", "Status feed")
        ' =============================================================================
        Rel(notification_toast, notification_dispatcher_ext, "Routes UI events through shared dispatcher.", "Client event bus")
        Rel(notification_toast, undo_controller, "Displays undo actions and handles timer expiry.", "Event handshake")
        Rel(notification_toast, observability_stack, "Reports severe errors for ops visibility.", "Telemetry stream")
        ' =============================================================================
        Rel(react_query_layer, lib_supabase_client, "Executes queries via shared client wrappers.", "Data fetch")
        Rel(react_query_layer, supabase_realtime, "Hydrates caches when messages arrive.", "Realtime hook")
        Rel(react_query_layer, mutation_service, "Invalidates + refetches after RPC success.", "Cache operations")
        ' =============================================================================
        Rel(realtime_adapter, supabase_realtime, "Subscribes/unsubscribes to company channels.", "Realtime websocket")
        Rel(realtime_adapter, presence_channel, "Publishes heartbeat/presence data.", "Presence feed")
        Rel(realtime_adapter, device_manager, "Receives connectivity status and triggers fallback.", "Status callback")
        ' =============================================================================
        Rel(mutation_service, supabase_rpc_layer, "Calls stored procedures with typed payloads.", "RPC POST") <<rpc-flow>>
        Rel(mutation_service, edge_action_client, "Executes server actions for low-latency flows.", "Edge runtime")
        Rel(mutation_service, auth_client, "Injects actor_id/company_id/role claims.", "JWT context")
        Rel(mutation_service, telemetry_collector, "Logs RPC latency + failures.", "Telemetry stream")
        Rel(mutation_service, observability_stack, "Emits traces + logs for operations.", "OTLP exporter")
        ' =============================================================================
        Rel(undo_controller, supabase_rpc_layer, "Calls revert RPC with undo_token.", "RPC POST") <<rpc-flow>>
        Rel(undo_controller, telemetry_collector, "Logs undo usage + expiry events.", "Analytics event")
        Rel(undo_controller, notification_toast, "Updates toasts when undo completes.", "UI event")
        ' =============================================================================
        Rel(presence_tracker, presence_channel, "Publishes heartbeat, focus view, assigned task id.", "Realtime channel")
        Rel(presence_tracker, telemetry_collector, "Feeds occupancy data for analytics.", "Monitored event")
        Rel(presence_tracker, access_guard, "Respects RBAC to avoid leaking cross-tenant presence.", "Role check")
        ' =============================================================================
        Rel(media_viewer, supabase_storage, "Streams video/image assets via signed URLs.", "HTTPS GET")
        Rel(media_viewer, device_manager, "Adapts controls for gloves/kiosk orientation.", "UI hints")
        Rel(media_viewer, feature_flag_registry, "Toggles experimental media scrubbing gestures.", "Flag context")
        ' =============================================================================
        Rel(access_guard, auth_client, "Parses JWT claims for role + company_id + RLS context.", "Session info")
        Rel(access_guard, lib_shared_models, "Uses canonical role enums + policy metadata.", "Type usage")
        Rel(access_guard, task_board, "Filters tasks + actions based on role allowances.", "Guard layer")
        ' =============================================================================
        Rel(flag_gateway, flagsmith_service, "Fetches evaluated flags for device + role.", "HTTPS / SSE")
        Rel(flag_gateway, telemetry_collector, "Reports exposures + variants for analysis.", "Telemetry")
        Rel(flag_gateway, feature_flag_registry, "Reads metadata for description + kill-switch.", "Config read")
        ' =============================================================================
        Rel(telemetry_collector, observability_stack, "Exports spans/logs/metrics.", "OTLP")
        Rel(telemetry_collector, doppler_runtime, "Uses Doppler-provided keys for exporters.", "Config")
        Rel(telemetry_collector, admin_person, "Feeds dashboards consumed by ops + managers.", "Visualization")
        ' =============================================================================
        Rel(auth_client, doppler_runtime, "Receives Supabase env values and PKCE config.", "Env injection")
        Rel(auth_client, supabase_rpc_layer, "Obtains tokens + role claims for RPC use.", "Auth handshake")
        Rel(auth_client, server_entry, "Supplies session info to server render path.", "Context")
        Rel(auth_client, device_manager, "Determines if offline, triggers re-auth banners.", "Status callback")
        ' =============================================================================
        Rel(edge_action_client, app_api, "Calls server actions hosted in Next.js API routes.", "Edge fetch")
        Rel(edge_action_client, supabase_rpc_layer, "Executes fallback RPC when Edge offline.", "HTTP fallback")
        ' =============================================================================
        Rel(device_manager, error_boundary, "Signals offline/reconnect states.", "Event bus")
        Rel(device_manager, notification_toast, "Shows connectivity warnings + fallback instructions.", "Toast events")
        Rel(device_manager, localization_layer, "Passes locale/timezone data per device.", "Metadata")
        ' =============================================================================
        Rel(error_boundary, notification_toast, "Displays fail-closed message to staff.", "UI update")
        Rel(error_boundary, telemetry_collector, "Logs fatal errors with stack traces.", "Telemetry")
        Rel(error_boundary, access_guard, "Prevents unauthorized fallback data from rendering.", "Guard path")
        ' =============================================================================
        Rel(localization_layer, lib_shared_models, "Translates measurement enums + units.", "Reference data")
        Rel(localization_layer, task_board, "Formats units + timers per locale/timezone.", "UI helper")
        Rel(localization_layer, recipe_drawer, "Displays ingredient scales + conversions.", "UI helper")
        ' =============================================================================
        SHOW_LEGEND()
        ' =============================================================================
        @enduml
        ~~~

*   **3.6. Data Model Overview & ERD:**
    *   **Description:** The ERD captures every tenant-scoped table defined in the foundation, reinforcing how company_id propagates through users, events, tasks, recipes, media, audit logs, and auxiliary governance tables.
        Each entity includes versioning, undo metadata, or status columns that power undo flows, task grouping, and kiosk summaries without denormalizing the structure.
        Relationships emphasize company ownership cascades, event-to-task linkages, combined task group references, and the supporting tables for comments, stations, schedules, and display snapshots.
    *   **Key Entities:**
        - Companies, Users, and RoleAssignment tables define tenant membership plus RBAC auditability.
        - Events, Tasks, CombinedTaskGroup, and TaskComment capture operational prep data, heuristics, and staff notes.
        - Recipes, MethodDocument, MediaAsset, and Station store knowledge assets, structured instructions, and prep routing metadata.
        - StaffSchedule, NotificationPreference, RealtimeSubscription, and DisplaySnapshot keep surrounding coordination data, device presence, and kiosk caches aligned with the platform.
    *   **Diagram (PlantUML - ERD):**
        ~~~plantuml
        @startuml
        ' =============================================================================
        ' CaterKing ERD - Supabase Postgres schema with tenant scoping.
        ' =============================================================================
        hide circle
        skinparam linetype ortho
        skinparam class {
          BackgroundColor Snow
          ArrowColor Black
          BorderColor DimGray
        }
        ' -----------------------------------------------------------------------------
        entity "companies" as companies {
          *id : uuid
          --
          name : text
          timezone : text
          settings : jsonb
          created_at : timestamptz
        }
        ' -----------------------------------------------------------------------------
        entity "users" as users {
          *id : uuid
          --
          company_id : uuid
          role : text
          display_name : text
          avatar_url : text
          contact_info : jsonb
          status : text
          created_at : timestamptz
        }
        ' -----------------------------------------------------------------------------
        entity "events" as events {
          *id : uuid
          --
          company_id : uuid
          name : text
          scheduled_at : timestamptz
          location : text
          notes : text
          status : text
          created_at : timestamptz
        }
        ' -----------------------------------------------------------------------------
        entity "tasks" as tasks {
          *id : uuid
          --
          company_id : uuid
          event_id : uuid
          name : text
          quantity : numeric
          unit : text
          status : text
          priority : text
          assigned_user_id : uuid
          combined_group_id : uuid
          instructions_ref : uuid
          undo_token : text
          station_id : uuid
          created_at : timestamptz
          updated_at : timestamptz
        }
        ' -----------------------------------------------------------------------------
        entity "combined_task_groups" as combined_task_groups {
          *id : uuid
          --
          company_id : uuid
          base_task_ids : jsonb
          aggregated_quantity : numeric
          unit : text
          heuristic_metadata : jsonb
          approved_by_user_id : uuid
          created_at : timestamptz
        }
        ' -----------------------------------------------------------------------------
        entity "recipes" as recipes {
          *id : uuid
          --
          company_id : uuid
          name : text
          ingredients : jsonb
          steps : jsonb
          media_urls : jsonb
          version : integer
          tags : text[]
          allergen_flags : text[]
          created_at : timestamptz
        }
        ' -----------------------------------------------------------------------------
        entity "method_documents" as method_documents {
          *id : uuid
          --
          company_id : uuid
          title : text
          steps : jsonb
          video_refs : jsonb
          skill_level : text
          last_reviewed_by : uuid
          created_at : timestamptz
        }
        ' -----------------------------------------------------------------------------
        entity "media_assets" as media_assets {
          *id : uuid
          --
          company_id : uuid
          url : text
          type : text
          thumbnail_url : text
          duration : integer
          checksum : text
          storage_path : text
          related_recipe_id : uuid
          related_method_id : uuid
          status : text
          created_at : timestamptz
        }
        ' -----------------------------------------------------------------------------
        entity "role_assignments" as role_assignments {
          *id : uuid
          --
          company_id : uuid
          user_id : uuid
          role : text
          granted_by : uuid
          granted_at : timestamptz
          revoked_at : timestamptz
        }
        ' -----------------------------------------------------------------------------
        entity "audit_logs" as audit_logs {
          *id : uuid
          --
          company_id : uuid
          user_id : uuid
          entity_type : text
          entity_id : uuid
          action : text
          diff : jsonb
          created_at : timestamptz
        }
        ' -----------------------------------------------------------------------------
        entity "notification_preferences" as notification_preferences {
          *id : uuid
          --
          company_id : uuid
          user_id : uuid
          channel : text
          enabled : boolean
          quiet_hours : jsonb
          created_at : timestamptz
        }
        ' -----------------------------------------------------------------------------
        entity "realtime_subscriptions" as realtime_subscriptions {
          *id : uuid
          --
          company_id : uuid
          user_id : uuid
          channel_name : text
          last_seen_event_id : uuid
          device_id : text
          last_heartbeat_at : timestamptz
        }
        ' -----------------------------------------------------------------------------
        entity "task_comments" as task_comments {
          *id : uuid
          --
          company_id : uuid
          task_id : uuid
          author_id : uuid
          body : text
          created_at : timestamptz
        }
        ' -----------------------------------------------------------------------------
        entity "stations" as stations {
          *id : uuid
          --
          company_id : uuid
          name : text
          type : text
          sort_order : integer
        }
        ' -----------------------------------------------------------------------------
        entity "staff_schedules" as staff_schedules {
          *id : uuid
          --
          company_id : uuid
          user_id : uuid
          event_id : uuid
          shift_start : timestamptz
          shift_end : timestamptz
          role_override : text
        }
        ' -----------------------------------------------------------------------------
        entity "display_snapshots" as display_snapshots {
          *id : uuid
          --
          company_id : uuid
          payload : jsonb
          captured_at : timestamptz
          source_event_id : uuid
        }
        ' -----------------------------------------------------------------------------
        ' Relationships enforcing tenant isolation and lifecycle flows.
        ' -----------------------------------------------------------------------------
        companies ||--o{ users : "1:N staff"
        companies ||--o{ events : "1:N events"
        companies ||--o{ tasks : "Tenant scope"
        companies ||--o{ combined_task_groups : "Group metadata"
        companies ||--o{ recipes : "Recipe catalog"
        companies ||--o{ method_documents : "Method library"
        companies ||--o{ media_assets : "Media storage"
        companies ||--o{ role_assignments : "RBAC audit"
        companies ||--o{ audit_logs : "Compliance trail"
        companies ||--o{ notification_preferences : "Personal settings"
        companies ||--o{ realtime_subscriptions : "Device presence"
        companies ||--o{ task_comments : "Operational chatter"
        companies ||--o{ stations : "Kitchen routing"
        companies ||--o{ staff_schedules : "Shift planning"
        companies ||--o{ display_snapshots : "Kiosk cache"
        ' -----------------------------------------------------------------------------
        users ||--o{ tasks : "assigned_user_id"
        users ||--o{ role_assignments : "target user"
        users ||--o{ audit_logs : "actor"
        users ||--o{ notification_preferences : "preferences"
        users ||--o{ realtime_subscriptions : "device heartbeat"
        users ||--o{ task_comments : "authors"
        users ||--o{ staff_schedules : "staff shifts"
        ' -----------------------------------------------------------------------------
        events ||--o{ tasks : "event tasks"
        events ||--o{ staff_schedules : "shift staffing"
        events ||--o{ display_snapshots : "context for kiosk digest"
        ' -----------------------------------------------------------------------------
        tasks ||--o{ task_comments : "notes"
        tasks }o--|| combined_task_groups : "optional group membership"
        tasks }o--|| stations : "routes to station"
        tasks }o..|| recipes : "instructions_ref -> recipe version"
        tasks }o..|| method_documents : "instructions_ref alt -> method"
        ' -----------------------------------------------------------------------------
        combined_task_groups ||--o{ audit_logs : "approval tracked"
        combined_task_groups }o--|| users : "approved_by"
        ' -----------------------------------------------------------------------------
        recipes ||--o{ media_assets : "media_urls references"
        method_documents ||--o{ media_assets : "video_refs references"
        media_assets }o--|| users : "uploaded by (via metadata)"
        ' -----------------------------------------------------------------------------
        notification_preferences }o--|| users : "owner"
        realtime_subscriptions }o--|| users : "subscriber"
        task_comments }o--|| users : "authors"
        ' -----------------------------------------------------------------------------
        role_assignments }o--|| users : "granted_by (self-join)"
        audit_logs }o--|| users : "actor reference"
        ' -----------------------------------------------------------------------------
        display_snapshots }o--|| events : "source_event_id optional"
        ' -----------------------------------------------------------------------------
        @enduml
        ~~~

    *   **Data Dictionary (Narrative Overview):**
        - `companies`: Master tenant definition storing canonical name, timezone, and JSONB settings used to scope every policy.
          Acts as the parent row for all multi-tenant RLS checks and drives realtime channel prefixes plus bucket partitioning.
          Timezone is referenced by localization utilities to ensure timers and deadlines render consistently per kitchen.
        - `users`: Captures staff identities, Supabase Auth linkage, avatars, contact metadata, and runtime status for presence features.
          `role` is constrained to staff, manager, event lead, or owner and is mirrored inside JWT claims plus libs/shared enums.
          Soft status values (active, invited, disabled) help admin tooling manage onboarding without deleting rows that feed audit logs.
        - `events`: Represents each catering engagement with schedule, notes, and lifecycle status, acting as the organizing boundary for tasks and staffing.
          Location plus notes feed kiosk displays and admin calendars, while `status` powers advanced filtering and archival sweeps.
          `scheduled_at` and timezone ensure cross-location planning remains deterministic even before multi-site support.
        - `tasks`: Core operational unit storing prep steps, quantity/unit combos, status lifecycle, priority, and persona assignment.
          `instructions_ref` can target either recipes or method documents to keep instructions normalized yet traceable.
          `undo_token`, `station_id`, and `combined_group_id` allow optimistic flows, station grouping, and heuristic grouping to coexist.
        - `combined_task_groups`: Immutable history of every approved consolidation, storing base task IDs, aggregated units, heuristics metadata, and approver.
          Rows let managers inspect why tasks were merged and supply audit references during training or dispute resolution.
          JSONB metadata keeps algorithm signals for future analytics without altering the normalized schema.
        - `recipes`: Stores per-company knowledge base entries with versioned ingredients, steps, tagged metadata, allergen flags, and media references.
          Version increments are mandatory on edit, enabling staff to load historical steps for quality assurance.
          Tags and allergen flags power filtered search within drawers and admin CRM forms without requiring extra join tables.
        - `method_documents`: Houses procedural guides, step-by-step training flows, and optional reviewer references for onboarding programs.
          `video_refs` parallels recipe media but keeps method-specific semantics, ensuring training flows stay modular.
          `skill_level` helps admin dashboards recommend content to trainees when tasks involve specialized skills.
        - `media_assets`: Tracks storage URLs, derived thumbnails, durations, checksums, recipe/method relationships, and processing status.
          Separate status values (pending, processing, ready, failed) align with recipe drawer warnings and admin upload dashboards.
          Checksums and storage paths enable deduplication plus rollback if a bad upload needs deletion.
        - `role_assignments`: Append-only ledger describing how roles were granted or revoked, including actor metadata for compliance.
          Even if a user changes role, the ledger preserves chronology for future audit exports.
          These rows feed behavior-level toasts so managers know when role changes propagate.
        - `audit_logs`: System of record for everything from task combinations to recipe edits, storing diffs and actor_id.
          Each entry includes entity type and ID so admin CRM surfaces can filter logs contextually.
          Diff JSONB follows a normalized before/after structure so future analytics can compute aggregate change patterns.
        - `notification_preferences`: Stores per-user settings for push/email/SMS readiness, enabling future channel expansion without schema churn.
          Quiet hours JSONB persists start/end times and timezone-specific adjustments.
          Staff defaults originate from company-level settings but can be overridden row-by-row.
        - `realtime_subscriptions`: Tracks active device presence, channel names, last seen event, and device IDs for kiosk health monitoring.
          Heartbeat timestamps allow ops to detect stale tablets and raise alerts before service disruptions.
          Device metadata also powers occupancy analytics for future staffing reports.
        - `task_comments`: Lightweight collaboration entity capturing short operational notes tied to a task and author.
          Comments inherit company_id for RLS and rely on sanitized text to prevent injection.
          Admin CRM surfaces highlight unresolved comment threads as part of QA workflows.
        - `stations`: Defines prep stations, line areas, or functional zones, allowing tasks to be filtered and grouped in UI dashboards.
          Sorting fields ensure consistent ordering across surfaces, while `type` drives kiosk segmentation.
          Future analytics modules can join tasks to stations for load balancing insights without extra schema adjustments.
        - `staff_schedules`: Records planned shifts, event assignments, and optional role overrides for ad-hoc staffing.
          Data supports manager dashboards and cross-event load balancing heuristics.
          Combined with realtime presence, it becomes the foundation for future labor efficiency KPIs.
        - `display_snapshots`: Captures JSON payloads used by kiosks when realtime is degraded or to satisfy compliance reviews.
          Each snapshot references the company and optional event to scope content.
          Chronological history lets ops audit what kitchens saw during a specific service window.

    *   **RLS & Indexing Matrix:**
        - Task queries rely on composite indexes over `(company_id, event_id, status)` plus GIN indexes on JSONB metadata to ensure rapid filtering.
          RLS enforces `company_id = auth.uid()` mapped claim and, for managers, permits cross-event reads while staff are limited to assigned events.
          Undo tokens are scoped by company, preventing cross-tenant revert attempts.
        - Combined task groups include indexes on `(company_id, array(base_task_ids))` to quickly fan back out into individual tasks when decomposing.
          Policies allow only managers or owners to read groups they approved, while staff can only view groups referencing their assigned tasks.
          Approver IDs are validated against role assignments within stored procedures.
        - Recipes and method documents use B-Tree indexes on `(company_id, name)` plus GIN indexes over tags/allergen flags for fast search.
          RLS restricts reads to company scope, and writes require manager or owner roles validated via JWT claims.
          Version increments occur inside stored procedures to avoid race conditions caused by parallel edits.
        - Media assets leverage indexes on `(company_id, status)` and `checksum` to detect duplicates and filter processing queues efficiently.
          Storage hooks insert rows using service-role credentials but still include company context for RLS enforcement.
          Staff only read `ready` assets, while managers see pending/failed states for troubleshooting.
        - Role assignments and audit logs both rely on timestamp indexes plus `company_id` to power fast chronological queries per tenant.
          Only owner-level roles may mutate role assignments; other personas receive read-only visibility filtered by company.
          Audit logs remain append-only, and even admins cannot delete without dedicated maintenance scripts.
        - Notification preferences and realtime subscriptions use indexes on `(company_id, user_id)` to keep preference lookups cheap inside API routes.
          RLS ensures that a user can only view or edit their own subscription rows unless elevated privileges exist.
          Managers can inspect aggregated subscription statuses for duty-of-care monitoring.
        - Task comments and stations include indexes on `(company_id, task_id)` and `(company_id, sort_order)` respectively to support UI grouping.
          Comments inherit writer identity and enforce sanitized length to keep tables tight.
          Station definitions only allow owner or manager modifications, ensuring staff cannot reshuffle workflows mid-service.
        - Staff schedules rely on composite `(company_id, event_id, shift_start)` indexes, enabling fast queries for upcoming shifts.
          Policies permit staff to view schedules they participate in but prevent them from editing without elevated roles.
          Event leads can adjust schedule role overrides, enabling last-minute coverage updates with audit logging.
        - Display snapshots use `(company_id, captured_at desc)` covering indexes and retain data per retention policy (e.g., 7 days hot, 30 days warm).
          Access limited to managers, owners, and kiosk service accounts reading via scoped access tokens.
          Supabase cron jobs purge aged rows while archiving zipped exports for compliance.
        - Supabase storage metadata tables (managed by Supabase) complement the schema yet always include company-specific folder prefixes enforced by policies.
          Access to storage buckets is mediated by signed URLs created via RPC functions that double-check row ownership.
          CDN caching respects `company_id` naming to prevent cross-tenant asset leakage.

    *   **Realtime Channel Registry:**
        - `company:{company_id}:tasks`: Primary feed for task creation, claim, complete, undo, and combination updates, carrying diff payloads and undo tokens.
          Staff subscribe with filters derived from role/assigned events, while kiosk display uses summary view events to avoid overload.
          Mutation RPCs include `source` metadata so clients can reconcile optimistic updates only when server confirms.
        - `company:{company_id}:events`: Broadcasts event lifecycle changes, staffing adjustments, and attribute edits to keep admin dashboards synchronized.
          Event leads rely on this to see new prep lists appear instantly after managers add them.
          Display app listens for status toggles to highlight urgent events.
        - `company:{company_id}:recipes`: Emits recipe version increments, ingredient updates, and method links for drawers to refresh.
          Staff clients throttle updates to avoid jarring UI while a recipe is open mid-task.
          Admin CRM uses the channel to coordinate collaborative edits and highlight version conflicts.
        - `company:{company_id}:methods`: Equivalent feed for method documents, ensuring trainees see new tutorials as soon as they are published.
          Presence service uses this channel to ping watchers when training content is marked urgent.
          Behavior architects can gate experimental training flows behind feature flags yet still reuse the same channel name.
        - `company:{company_id}:media`: Notifies when Supabase functions finish transcoding, update status fields, or detect checksum collisions.
          Recipe drawers listen to show warnings until `status=ready`.
          Admin CRM surfaces display the same feed inside upload panels.
        - `company:{company_id}:audit`: Streams audit log append events to admin dashboards so compliance officers can watch high-risk actions live.
          Logging UI batches events by entity and highlights repeated failures.
          Observability stack mirrors this to long-term storage for runbook-driven investigations.
        - `company:{company_id}:presence`: Aggregates heartbeats from tablets, kiosks, and staff devices, enabling occupancy analytics and kiosk health checks.
          Managers can identify idle devices quickly and redeploy hardware mid-service.
          Presence also powers door-check features planned for future releases.
        - `company:{company_id}:display`: Serves kiosk snapshots and urgent alert banners, ensuring wall displays pick up both aggregated metrics and manual overrides.
          If realtime fails, display surfaces switch to polling the materialized views but keep the same schema for compatibility.
          Snapshot payloads include schema_version values so clients can adapt gracefully across releases.
        - `company:{company_id}:notifications`: Acts as backbone for toasts, undo prompts, and future push connectors, normalizing payloads and TTL.
          Notification dispatcher ensures duplicates collapse via idempotency keys.
          Staff clients degrade to local timers if realtime connection is not available.
        - `company:{company_id}:flags`: Optional channel for streaming flag changes to long-lived kiosk sessions when Flagsmith webhooks fire.
          Helps ensure environment toggles propagate instantly even without page reloads.
          Clients treat this channel as advisory and fall back to periodic fetch if disconnected.

    *   **Storage & Media Governance:** 
        - Each company receives a dedicated Supabase Storage folder (`company-{id}/media/`) enforced by bucket policies to prevent cross-tenant listing.
          Upload flows issue time-bound signed URLs and include checksum hints to detect duplicates quickly.
          Metadata rows inside `media_assets` maintain pointer integrity for future migrations.
        - Video assets trigger Supabase Functions that transcode to web-friendly bitrates and generate thumbnail frames stored with deterministic suffixes.
          Drawer UI reads `thumbnail_url` if streaming still in progress, keeping the experience responsive.
          Admin CRM surfaces show per-asset processing states so staff know when to retry.
        - Large media uploads run through background status webhooks that update audit logs with progress and failure reasons.
          When failures occur, admins receive notification dispatcher toasts plus entries inside audit logs.
          Staff drawers display safety banners instructing them to rely on fallback text instructions temporarily.
        - Recipe and method attachments respect retention policies; by default assets stay hot for one year before optional archival.
          Owners can configure longer retention using company settings stored in the `settings` JSONB field.
          Archival jobs write summary rows referencing cold-storage locations for compliance retrieval.
        - Kiosk displays cache reduced-resolution imagery to minimize bandwidth and memory.
          Cached assets store `checksum` values so clients can detect when to refresh without redownloading.
          Display snapshots also keep a pointer to the cache manifest for debugging.
        - Future outbound connectors (e.g., push notifications or inventory images) will reuse the same storage organization to avoid snowflake structures.
          Architecture reserves `future_use` keys inside metadata JSON so migrations remain additive.
          Supabase bucket policies already anticipate new roles by grouping permissions via JWT claims rather than static role names.

    *   **Supabase RPC Contracts:**
        - `claim_task(task_id uuid, actor_id uuid, idempotency text)`: Validates actor permissions, reserves the task, emits audit logs, and publishes realtime messages with undo tokens.
          Enforces station assignment constraints and rejects double claims by comparing timestamps plus idempotency hash.
          Returns server timestamps so optimistic UI can reconcile state precisely.
        - `complete_task(task_id uuid, completion_payload jsonb)`: Marks tasks complete, validates outstanding combine approvals, and writes audit entries referencing prior state.
          Generates `undo_token` rows and triggers notifications to watchers for the undo window.
          Publishes summary deltas to keep kiosk counts synchronized.
        - `combine_tasks(task_array jsonb, actor_id uuid, metadata jsonb)`: Runs heuristic validations, writes combined_task_groups rows, updates child tasks, and persists aggregated units.
          Requires manager or event lead role; staff actions route through approval queues with audit tombstones.
          Emits detailed metadata to realtime channels so UI can show breakdown popovers.
        - `log_audit_event(entity_type text, entity_id uuid, diff jsonb, actor_id uuid)`: Shared helper invoked by API routes and Supabase functions to centralize audit formatting.
          Ensures diff schema_version is stamped and that payload respects tenant scope.
          Supports batching to minimize transaction overhead during migrations.
        - `issue_signed_upload(media_context jsonb)`: Allocates Supabase Storage URLs, whitelists MIME types, and stores pending `media_assets` rows before upload.
          Validates company_id plus per-role upload quotas configured in `companies.settings`.
          Returns pre-signed URLs plus callback endpoints used by background functions.
        - `archive_snapshot(display_payload jsonb)`: Inserts into `display_snapshots`, enforces retention quotas, and triggers optional cold-storage export jobs.
          Called by kiosk display on failover and by scheduled Supabase cron tasks for compliance.
          Responds with snapshot metadata to confirm capture success to UI.
        - `upsert_schedule(schedule jsonb)`: Handles `staff_schedules` CRUD operations, verifying that shift windows do not overlap for the same staffer.
          Enforces manager/event lead permissions and logs adjustments for payroll or compliance follow-up.
          Returns normalized schedule rows for immediate React Query hydration.
        - `emit_notification(payload jsonb)`: Central dispatcher invoked by API routes and Supabase functions to push entries into notification pipelines.
          Supports channel fan-out (toast, upcoming push, email) while embedding idempotency keys to suppress duplicates.
          Links notifications to audit logs for traceability when alerts represent policy-sensitive events.

    *   **Feature Flag Inventory & Rollout Notes:**
        - `prep.task-combine.v1`: Governs heuristic suggestions for combining tasks, defaulted off in production until QA sign-off per company.
          Requires telemetry logging of impressions, acceptances, and declines to understand adoption.
          Server-side evaluation ensures unauthorized clients cannot spoof combination prompts.
        - `prep.undo-extended-window`: Controls whether undo durations extend from five to ten minutes for high-trust tenants.
          Feature flagged to avoid increasing audit risk in kitchens without necessary training.
          When disabled, UI still shows baseline undo behavior sourced from shared constants.
        - `display.snapshot-polling.v2`: Enables smarter kiosk fallback loops that alternate between realtime and polling every 10 seconds.
          Allows ops to roll out improved heuristics gradually while monitoring CPU load on kiosk devices.
          Channel metadata includes variant so analytics can compare performance before full rollout.
        - `admin.recipe-version-diff`: Unlocks inline diff viewer for recipe edits, aligning with future multi-editor workflows.
          Dark-launched to owner accounts first so content teams can validate accuracy.
          Adds `diff` payloads to audit events only when flag is enabled to keep logs lean otherwise.
        - `methods.training-recommendations`: Surfaces recommended methods to trainees based on tasks claimed in PrepChef.
          Initially scoped to staging tenants for usability testing.
          Relies on libs/rag scaffolding but gracefully hides suggestions when flag disabled.
        - `notifications.push-preview`: Prepares infrastructure for push notification connectors while still confining MVP to in-app toasts.
          Allows QA teams to validate payload formatting and localization before enabling actual push channels.
          Hooks into `emit_notification` RPC but short-circuits to logs when variant `off`.
        - `presence.kiosk-heartbeat-alerts`: Governs whether kiosk offline events trigger admin toasts and display banners.
          Useful for single-location pilots to test noise levels before global activation.
          Observability pipelines tag these alerts for follow-up analysis.
        - `recipes.media-autoplay`: Determines if recipe videos autoplay when staff open drawers, balancing engagement with bandwidth.
          Feature remains off by default on slow networks or shared tablets.
          Drawer UI reads this flag server-side to avoid layout shift.

    *   **Telemetry Streams:**
        - `interaction.prepchef.task-actions`: Captures button taps, durations between claim and completion, and undo usage, emitting to OpenTelemetry spans and structured logs.
          Metrics bucket by company, event, station, and user role to inform future efficiency dashboards.
          Sensitive identifiers are tokenized before leaving the edge runtime.
        - `media.drawer.performance`: Measures media load times, buffering incidents, and fallback asset usage during recipe/method viewing.
          Data helps operations tune transcoding profiles and CDN cache hints.
          Alerts trigger if failure percentages exceed thresholds defined in Doppler configs.
        - `admin.audit.review`: Tracks how often managers open audit viewers, filter logs, or export data, ensuring UI investments align with actual behavior.
          Combined with Flagsmith exposures, this stream highlights whether new governance features see adoption.
          Reports feed monthly compliance summaries stored alongside release notes.
        - `presence.device.health`: Logs heartbeat gaps, reconnect attempts, and fallback polling activations for tablets and kiosks.
          Provides early-warning indicators for network degradation or hardware issues.
          Coupled with staff schedule data, it reveals when certain shifts need additional redundant devices.

    *   **Edge Deployment Guardrails:**
        - Vercel deployments run through Turbo pipelines that verify Supabase migrations, feature flag defaults, and telemetry exporters before promoting to staging or production.
          Rollbacks reference Doppler-managed snapshots so env drift cannot slip past release automation.
          Each deployment stores metadata inside audit logs for traceability across tenants.
        - Edge routes remain stateless and deterministic, forbidding filesystem writes or global caches to keep functions safe for multi-tenant workloads.
          Long-running operations are offloaded to Supabase Functions, ensuring request durations stay predictable even under heavy load.
          Shared adapters enforce timeouts and structured error payloads so clients degrade gracefully.
        - Environment-specific toggles (dev/staging/prod) are centralized via typed config modules that surface fallbacks if Doppler fails.
          Apps refuse to boot when required secrets or feature flag baselines are missing, preventing half-configured deployments.
          Observability alerts trigger whenever config drift occurs so ops can intervene quickly.

---

<!-- anchor: structural-data-architect-output -->
## Structural & Data Architect Output - `02_System_Structure_and_Data.md`

| Project Scale | Line Count | Diagram Complexity |
|---------------|------------|-------------------|
| **Small** | 200-350 lines | - 1 Context diagram (30-40 lines)<br>- 1 Container diagram (40-60 lines)<br>- Simple ERD (20-30 lines)<br>- Minimal component detail |
| **Medium** | 500-800 lines | - Context diagram (50-70 lines)<br>- Container diagram (80-120 lines)<br>- Component diagram (60-100 lines)<br>- Detailed ERD (40-80 lines) |
| **Large** | 1000-1500 lines | - Complex Context (80-120 lines)<br>- Multiple Container views (150-250 lines)<br>- 2-3 Component diagrams (200-300 lines)<br>- Comprehensive ERD (100-150 lines) |
| **Enterprise** | 1800-2500 lines | - Enterprise Context (150-200 lines)<br>- Multiple system boundaries (300-400 lines)<br>- 4-6 Component diagrams (400-600 lines)<br>- Multi-schema ERD (200-300 lines) |

**Content Distribution:**
- Introduction & Goals: 10-15%
- Architectural Drivers: 10-15%
- Diagrams (PlantUML): 50-60%
- Descriptions & Explanations: 20-25%

**Quality Guidelines:**
- MUST adhere to the specified line count range. Diagram content MUST be 50-60% of total lines. All required diagrams (Context, Container, Component, ERD) are MANDATORY. Outputs below minimum are INCOMPLETE. Outputs above maximum are OVER-DETAILED.
