[
  {
    "task_id": "I2.T1",
    "iteration_id": "I2",
    "iteration_goal": "Implement the core task/event data flows (migrations, RPCs, API routes, realtime channels, PrepChef hooks) plus the canonical OpenAPI/sequence artifacts so both staff and manager experiences can build confidently.",
    "description": "Extend Supabase schema with additional task lifecycle columns (priority, undo tokens, timestamps, presence heartbeats), materialized summary views, and helper tables (TaskSimilaritySuggestions, RealtimeSubscriptions) to support realtime dashboards.",
    "agent_type_hint": "DatabaseAgent",
    "inputs": "I1 schema, blueprint data model, ERD references.",
    "target_files": [
      "supabase/migrations/0003_task_lifecycle.sql",
      "supabase/migrations/0004_summary_views.sql",
      "docs/diagrams/supabase_erd.mmd"
    ],
    "input_files": ["supabase/migrations/0001_base_schema.sql", "docs/diagrams/supabase_erd.mmd"],
    "deliverables": "- Migration adding priority enums, undo metadata, `task_similarity_suggestions`, `realtime_subscriptions`, `undo_tokens` tables, and indexes.\n        - Materialized views for `/display` summary plus refresh cron SQL.\n        - ERD update capturing new tables/relationships + textual changelog appended to diagram index.",
    "acceptance_criteria": "`supabase db lint` passes; views refresh successfully; ERD diff logged; migrations reversible via down scripts.",
    "dependencies": ["I1.T4", "I1.T5"],
    "parallelizable": false,
    "done": true
  },
  {
    "task_id": "I2.T2",
    "iteration_id": "I2",
    "iteration_goal": "Implement the core task/event data flows (migrations, RPCs, API routes, realtime channels, PrepChef hooks) plus the canonical OpenAPI/sequence artifacts so both staff and manager experiences can build confidently.",
    "description": "Implement stored procedures (`claim_task`, `complete_task`, `undo_task`, `combine_tasks`) plus row-level audit triggers and Zod-described DTOs inside `libs/shared`.",
    "agent_type_hint": "DatabaseAgent",
    "inputs": "Fresh schema, blueprint contract requirements, undo requirements.",
    "target_files": [
      "supabase/functions/claim_task.sql",
      "supabase/functions/complete_task.sql",
      "supabase/functions/undo_task.sql",
      "libs/shared/src/dto/tasks.ts"
    ],
    "input_files": ["supabase/migrations/0003_task_lifecycle.sql", "docs/security/rls_policies.md"],
    "deliverables": "- SQL functions enforcing role permissions, idempotency keys, undo token issuance, audit logging, and realtime NOTIFY payloads.\n        - Shared DTO definitions + Zod schemas for requests/responses, reused by API + UI.\n        - README snippet detailing RPC usage and idempotency expectations.",
    "acceptance_criteria": "Supabase tests cover success/failure paths; DTOs exported via `@caterkingapp/shared/tasks`; audit logs show sample entries; idempotency proved via repeated invocation tests.",
    "dependencies": ["I2.T1"],
    "parallelizable": false,
    "done": true
  },
  {
    "task_id": "I2.T3",
    "iteration_id": "I2",
    "iteration_goal": "Implement the core task/event data flows (migrations, RPCs, API routes, realtime channels, PrepChef hooks) plus the canonical OpenAPI/sequence artifacts so both staff and manager experiences can build confidently.",
    "description": "Implement Next.js API routes and server actions for `/api/tasks`, `/api/tasks/:id/claim`, `/api/tasks/:id/complete`, `/api/tasks/:id/undo`, `/api/events`, `/api/tasks/suggestions`, including error handling and telemetry emission.",
    "agent_type_hint": "BackendAgent",
    "inputs": "DTOs, RPC wrappers, blueprint API contract section.",
    "target_files": ["apps/prepchef/app/api/tasks/route.ts"],
    "input_files": [
      "libs/shared/src/dto/tasks.ts",
      "docs/architecture/03_Behavior_and_Communication.md"
    ],
    "deliverables": "- Type-safe API handlers calling RPC wrappers, validating payloads via Zod, emitting OTEL spans, and returning `schema_version` metadata.\n        - Shared error utility mapping Supabase errors to UI-friendly codes.\n        - Integration tests hitting handlers with mocked Supabase client verifying HTTP responses & telemetry.",
    "acceptance_criteria": "`pnpm test api` passes; handlers reject invalid payloads with 422; idempotent replays return previous success payloads; OTEL spans recorded in logs.",
    "dependencies": ["I2.T2"],
    "parallelizable": true,
    "done": true
  },
  {
    "task_id": "I2.T4",
    "iteration_id": "I2",
    "iteration_goal": "Implement the core task/event data flows (migrations, RPCs, API routes, realtime channels, PrepChef hooks) plus the canonical OpenAPI/sequence artifacts so both staff and manager experiences can build confidently.",
    "description": "Draft the Task Lifecycle sequence diagram capturing staff claim -> RPC -> Realtime -> Display update -> Undo, referencing UI + behavior requirements.",
    "agent_type_hint": "DiagrammingAgent",
    "inputs": "Behavior spec, API route design.",
    "target_files": ["docs/diagrams/task_lifecycle_seq.puml", "docs/diagrams/diagram_index.md"],
    "input_files": [
      "docs/architecture/03_Behavior_and_Communication.md",
      "docs/architecture/06_UI_UX_Architecture.md"
    ],
    "deliverables": "- PlantUML sequence file detailing PrepChef UI, libs/shared, API route, Supabase RPC, Realtime, Display, and Undo service interactions.\n        - Diagram index update describing scenario scope, dependencies, and iteration handshake.",
    "acceptance_criteria": "Diagram renders, includes undo failure branch, uses ASCII names, and is referenced by Task 2.7 instructions.",
    "dependencies": ["I2.T3"],
    "parallelizable": true,
    "done": true
  },
  {
    "task_id": "I2.T5",
    "iteration_id": "I2",
    "iteration_goal": "Implement the core task/event data flows (migrations, RPCs, API routes, realtime channels, PrepChef hooks) plus the canonical OpenAPI/sequence artifacts so both staff and manager experiences can build confidently.",
    "description": "Create the OpenAPI v3 draft covering all task/event endpoints with component schemas derived from libs/shared DTOs.",
    "agent_type_hint": "DocumentationAgent",
    "inputs": "API handlers, DTOs, blueprint API style.",
    "target_files": ["api/openapi.yaml", "api/README.md", "tests/contract/tasks.contract.test.ts"],
    "input_files": ["apps/prepchef/app/api/tasks/route.ts", "libs/shared/src/dto/tasks.ts"],
    "deliverables": "- OpenAPI spec with paths, parameters, request/response bodies, error schemas, and security (Supabase Auth) sections.\n        - README describing how to regenerate docs, run spectral lint, and share with partners.\n        - Contract test verifying API responses conform to schema via `pnpm test:contract`.",
    "acceptance_criteria": "`pnpm spectral lint api/openapi.yaml` passes; contract test fails if schema drifts; spec references iteration tasks for provenance.",
    "dependencies": ["I2.T3"],
    "parallelizable": true,
    "done": true
  },
  {
    "task_id": "I2.T6",
    "iteration_id": "I2",
    "iteration_goal": "Implement the core task/event data flows (migrations, RPCs, API routes, realtime channels, PrepChef hooks) plus the canonical OpenAPI/sequence artifacts so both staff and manager experiences can build confidently.",
    "description": "Build React Query hooks, server components, and UI skeleton for PrepChef task list (filters, grouping, summary header, bottom nav), wiring realtime adapter + optimistic mutations.",
    "agent_type_hint": "FrontendAgent",
    "inputs": "Component diagram, DTOs, API routes, UI blueprint.",
    "target_files": [
      "apps/prepchef/app/(shell)/layout.tsx",
      "apps/prepchef/app/tasks/page.tsx",
      "apps/prepchef/components/task-list.tsx",
      "libs/shared/src/hooks/useTasks.ts"
    ],
    "input_files": [
      "docs/diagrams/prepchef_components.puml",
      "libs/shared/src/dto/tasks.ts",
      "docs/ux/ui_interaction_blueprint.md"
    ],
    "deliverables": "- Server component streaming initial tasks + summary counts.\n        - React Query hook for filters + pagination, wired to realtime channel adapter.\n        - UI components for status chips, claim buttons, header summary, bottom nav, using libs/ui primitives.\n        - Storybook stories for task row states (available/claimed/complete/undo) with accessibility annotations.",
    "acceptance_criteria": "`pnpm test:ui` + Storybook build succeed; real-time updates reflected; optimistic claim/rescind works; layout respects gloves-friendly requirements.",
    "dependencies": ["I2.T3", "I2.T4"],
    "parallelizable": true,
    "done": true
  },
  {
    "task_id": "I2.T7",
    "iteration_id": "I2",
    "iteration_goal": "Implement the core task/event data flows (migrations, RPCs, API routes, realtime channels, PrepChef hooks) plus the canonical OpenAPI/sequence artifacts so both staff and manager experiences can build confidently.",
    "description": "Implement realtime/presence adapter utilities (`useRealtimeChannel`, `usePresenceHeartbeats`) plus notification dispatcher plumbing to show claim/undo toasts with TTL timers.",
    "agent_type_hint": "FrontendAgent",
    "inputs": "Sequence diagram, blueprint realtime strategy.",
    "target_files": [
      "libs/supabase/src/realtime/useRealtimeChannel.ts",
      "libs/supabase/src/presence/usePresence.ts",
      "libs/shared/src/notifications/dispatcher.ts",
      "apps/prepchef/components/undo-toast.tsx"
    ],
    "input_files": [
      "docs/diagrams/task_lifecycle_seq.puml",
      "docs/architecture/03_Behavior_and_Communication.md"
    ],
    "deliverables": "- Hooks handling subscribe/unsubscribe, reconnection, and filter scoping by company and entity.\n        - Presence heartbeat utility posting to `/api/presence` and updating avatar halos.\n        - Notification dispatcher state machine with TTL timers, stacking cap, and telemetry hooks.\n        - PrepChef component showing toast UI with accessible controls.",
    "acceptance_criteria": "Hooks tested via Vitest; toasts show copy + countdown; presence updates color avatars; reconnection fallback triggers polling.",
    "dependencies": ["I2.T4", "I2.T6"],
    "parallelizable": true,
    "done": true
  },
  {
    "task_id": "I2.T8",
    "iteration_id": "I2",
    "iteration_goal": "Implement the core task/event data flows (migrations, RPCs, API routes, realtime channels, PrepChef hooks) plus the canonical OpenAPI/sequence artifacts so both staff and manager experiences can build confidently.",
    "description": "Create Playwright smoke tests for `/tasks` covering initial load, claim, undo, realtime update, filter toggle, and API failure surfaces; integrate into CI pipeline.",
    "agent_type_hint": "QATestingAgent",
    "inputs": "PrepChef UI, notification flows, API endpoints.",
    "target_files": [
      "tests/playwright/prepchef.tasks.spec.ts",
      "tests/playwright/fixtures/tasks.json",
      ".github/workflows/ci.yml"
    ],
    "input_files": [
      "apps/prepchef/app/tasks/page.tsx",
      "apps/prepchef/components/undo-toast.tsx",
      "tests/playwright/README.md"
    ],
    "deliverables": "- Playwright spec covering load, claim, conflict resolution, undo expiration, offline banner, and filter chips.\n        - Fixtures/seeds hooking into Supabase CLI to ensure deterministic data.\n        - CI job updates running Playwright in headless mode with artifact uploads on failure.",
    "acceptance_criteria": "Test passes locally and in CI; failure screenshots saved; docs updated with troubleshooting steps.",
    "dependencies": ["I2.T6", "I2.T7"],
    "parallelizable": true,
    "done": true
  }
]
