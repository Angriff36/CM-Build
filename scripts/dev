#!/bin/bash

# Cross-platform dev script to spin up local environment
# Starts Supabase, runs pnpm dev for prepchef, seeds data, provides cleanup
# Compatible with macOS/Linux; for Windows, use WSL or Git Bash

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${YELLOW}Starting local development environment...${NC}"

# Check prerequisites
if ! command -v supabase &> /dev/null; then
  echo -e "${RED}Error: Supabase CLI not installed. Install from https://supabase.com/docs/guides/cli${NC}"
  exit 1
fi

if ! command -v pnpm &> /dev/null; then
  echo -e "${RED}Error: pnpm not installed. Install from https://pnpm.io/installation${NC}"
  exit 1
fi

# Start Supabase
echo -e "${YELLOW}Starting Supabase...${NC}"
supabase start
if [ $? -ne 0 ]; then
  echo -e "${RED}Failed to start Supabase. Check for port conflicts or Docker availability.${NC}"
  echo -e "${YELLOW}Troubleshooting: Run 'supabase stop' and try again, or check Docker Desktop.${NC}"
  exit 1
fi

# Run pnpm dev for prepchef in background
echo -e "${YELLOW}Starting PrepChef app...${NC}"
pnpm dev --filter apps/prepchef &
DEV_PID=$!

# Seed data
echo -e "${YELLOW}Seeding database...${NC}"
supabase db seed
if [ $? -ne 0 ]; then
  echo -e "${RED}Failed to seed database.${NC}"
  kill $DEV_PID 2>/dev/null
  supabase stop
  exit 1
fi

echo -e "${GREEN}Local environment ready!${NC}"
echo -e "${YELLOW}Access PrepChef at http://localhost:3000${NC}"
echo -e "${YELLOW}Cleanup instructions:${NC}"
echo -e "${YELLOW}  - Stop app: kill $DEV_PID${NC}"
echo -e "${YELLOW}  - Stop Supabase: supabase stop${NC}"
echo -e "${YELLOW}  - Full cleanup: kill $DEV_PID && supabase stop${NC}"

# Wait for dev process
wait $DEV_PID